#+TITLE: 202403 | ziglang.cc æ­£å¼ä¸Šçº¿
#+DATE: 2024-03-13T20:32:27+0800
#+LASTMOD: 2024-05-02T22:14:30+0800
* é‡å¤§äº‹ä»¶
#+begin_quote
https://ziglang.cc/
#+end_quote
ä¹‹å‰ ZigCC æ‰€æœ‰é¡¹ç›®éƒ½æ˜¯æ‰˜ç®¡åœ¨ GitHub ä¹‹ä¸Šï¼Œç½‘é¡µåŸºäº Pages æ„å»ºï¼ŒåŸŸåè‡ªç„¶ä¹Ÿå°±æ˜¯ github.io çš„ï¼Œè™½ç„¶ GitHub æä¾›äº†å¾ˆå¤šåˆ©äºå¼€å‘è€…çš„æœåŠ¡ï¼Œä½†è¿‡äºä¾èµ– GitHub è¿™ç§å•†ä¸šå…¬å¸ï¼Œè¿˜æ˜¯ä¸åˆ©äº ZigCC çš„é•¿è¿œå‘å±•ï¼ŒåŸŸåæ˜¯å…¶ä¸­å¾ˆé‡è¦ä¸€ä¸ªï¼Œæœ‰äº†ç‹¬ç«‹åŸŸåï¼Œç½‘é¡µæ‰˜ç®¡é€‰æ‹©å°±å¤šäº†ï¼Œæ¯”å¦‚ [[https://pages.cloudflare.com/][Cloudflare Pages]]ã€‚

å¦ä¸€ä¸ªå¤§å®¶æ¯”è¾ƒå…³å¿ƒçš„é—®é¢˜å°±æ˜¯ 0.12 çš„å‘ç‰ˆï¼Œè™½ç„¶ [[https://github.com/ziglang/zig/milestone/23][milestone]] æ˜¾ç¤ºè¿˜å‰© 10 æ¥ä¸ª open çš„ issueï¼Œä½†æ˜¯è¿™åªæ˜¯ä¸ªå¹Œå­ï¼Œæ ¸å¿ƒå›¢é˜Ÿè¿˜æ˜¯æœ‰å¯èƒ½éšæ—¶ delayã€‚ä¸è¿‡ä»å‰©ä¸‹çš„ issue æ¥åˆ†æï¼Œä¸»è¦é—®é¢˜è¿˜å‰©ä¸¤å¤§ç±»ï¼š
1. æ„å»ºç³»ç»Ÿå®Œå–„
2. ä¿®å¤ä¹‹å‰åŠŸèƒ½å¸¦æ¥çš„å›é¡¾é—®é¢˜ï¼ˆregression è¿™ä¸ª tagï¼‰

æ–°åŠŸèƒ½çœ‹æ¥æ˜¯å·²ç» ready äº†ï¼Œä½†è¿™å¹¶ä¸æ˜¯è¯´å‰©ä¸‹çš„è¿™äº›å·¥å…·å°±å¥½è§£å†³äº†ï¼ŒAndrew åœ¨ [[https://rustacean-station.org/episode/andrew-kelley/][Zig with Andrew Kelley]] è¿™ä¸€æœŸæ’­å®¢é‡Œæåˆ°çš„ [[https://zh.wikipedia.org/wiki/90-90%E6%B3%95%E5%88%99][90-90]] ç†è®ºå¾ˆå¥½çš„è§£é‡Šäº†è¿™ä¸€ç‚¹ï¼š
#+begin_quote
ï¼ˆå¼€å‘è½¯ä»¶æ—¶ï¼‰å‰ 90% çš„ä»£ç è¦èŠ±è´¹ 90% çš„å¼€å‘æ—¶é—´ï¼Œå‰©ä½™çš„ 10% çš„ä»£ç è¦å†èŠ±è´¹ 90% çš„å¼€å‘æ—¶é—´ã€‚
#+end_quote

å½“ç„¶ï¼Œåé¢ ZigCC ä¹Ÿä¼šç´§å¯†å…³æ³¨å‘å¸ƒåŠ¨æ€ï¼Œæœ‰æ¶ˆæ¯ç¬¬ä¸€æ—¶é—´åˆ†äº«ç»™å¤§å®¶ã€‚è€ä¸ä½å¯‚å¯çš„æœ‹å‹ï¼Œå¯ä»¥å…ˆå»åˆ·åˆ· Zig çš„ discordã€‚
* è§‚ç‚¹/æ•™ç¨‹
- [[https://github.com/ziglang/zig/pull/19208][Redesign How Autodoc Works]] :: Andrew åœ¨è¿™ä¸ª PR é‡Œé‡æ„äº†ç°æœ‰çš„æ–‡æ¡£ç³»ç»Ÿ Autodocï¼Œä¹‹å‰çš„å®ç°é—®é¢˜å¾ˆå¤šã€‚æ¯”å¦‚ï¼š
  - å¾ˆå¤šåŠŸèƒ½é‡å¤çš„æ–‡ä»¶ï¼Œæœ€å¤¸å¼ çš„æ˜¯ =lib/docs/ziglexer.js= ï¼Œå®ƒæ˜¯ç”¨ JS å®ç°çš„ Zig çš„è§£æå™¨ï¼Œå…¶å® Zig å·²ç»åœ¨æ ‡å‡†åº“ä¸­æš´éœ²è§£æç›¸å…³ APIï¼Œé€šè¿‡ wasm å°±å¯ä»¥è°ƒç”¨
  - åŠŸèƒ½æ›´å¼ºï¼Œå› ä¸ºæ–°è®¾è®¡æ–¹æ¡ˆä¸å†å¤„ç† ZIRï¼Œè€Œæ˜¯ç›´æ¥å¤„ç†æºæ–‡ä»¶ï¼Œè¿™æ„å‘³ç€å®ƒæ‹¥æœ‰100% çš„ä¿¡æ¯ï¼Œä¸éœ€è¦å‘åæ‹¼å‡‘ä»»ä½•ä¸œè¥¿ã€‚
  - sources.tar æ–‡ä»¶ç» HTTP å±‚è§£å‹åï¼Œç›´æ¥è¿›å…¥ wasm æ¨¡å—çš„å†…å­˜ã€‚ä½¿ç”¨ std.tar å¯¹ tar æ–‡ä»¶è¿›è¡Œè§£æï¼Œå¹¶å¯¹æºæ–‡ä»¶è¿›è¡Œå°±åœ°è§£æï¼ŒåŒæ—¶åœ¨å“ˆå¸Œè¡¨ä¸­æ·»åŠ ä¸€äº›é¢å¤–çš„è®¡ç®—ã€‚è™½ç„¶å¯ä»¥é€šè¿‡ Worker æ¥åŠ å¿«è§£æé€Ÿåº¦ï¼Œä½†å•çº¿ç¨‹çš„è§£æé€Ÿåº¦å·²ç»éå¸¸å¿«ï¼Œå› æ­¤è¿™å¹¶ä¸æ˜¯éå¸¸æœ‰å¿…è¦ã€‚

    å¿«æ¥ä½“éªŒæœ€æ–°çš„æ–‡æ¡£ç³»ç»Ÿå§ï¼šhttps://ziglang.org/documentation/master/std/
- [[https://notes.eatonphil.com/2024-03-15-zig-rust-and-other-languages.html][Zig, Rust, and other languages]] :: è€æœ‹å‹ Phil Eaton çš„æ–‡ç« ï¼Œåœ¨è¿™é‡Œä»–é’ˆå¯¹ä»¥ä¸‹å‡ ç‚¹è¿›è¡Œäº†è¯­è¨€å¯¹æ¯”ï¼š
  - å†…å­˜ç®¡ç†ã€‚Zig æœ€å¤§çš„é—®é¢˜æ˜¯ä¸æ”¯æŒ RAIIï¼Œä¸€ä¸ªè¿‘ä¼¼çš„æ¦‚å¿µæ˜¯ arenas åˆ†é…å™¨ã€‚
  - æ ‡å‡†åº“ï¼Œä¸»è¦æ˜¯è®¨è®ºæ ‡å‡†åº“æ˜¯å¦åº”è¯¥ç²¾ç®€ä¸ºä¸»ï¼Œ =node_modules= æ˜¯ä¸šç•Œç»å¸¸æåˆ°çš„ä¸€ä¸ªåé¢ä¾‹å­ï¼Œä¸€èˆ¬æ”¯æŒç²¾ç®€çš„äººä¼šè®¤ä¸ºï¼Œ
    - è¯­è¨€çš„ std ä¸å®¹æ˜“å‡ºç° breaking changesï¼Œæƒ³ Python é‡Œå°±æœ‰ urllibã€urllib2ã€urllib3 è¿™ä¸‰ä¸ªç½‘ç»œåº“ï¼Œ
      ä½†æ˜¯ç¤¾åŒºæ¨èçš„å¹¶ä¸æ˜¯è¿™ä¸‰ä¸ªï¼Œè€Œæ˜¯ requestsï¼Œè¿™æ · std çš„ä½ç½®å°±æœ‰äº›å°´å°¬
    - Zig ç›®å‰çš„æ ‡å‡†åº“ç®—æ˜¯ä¸­ç­‰å¤§å°ï¼Œjsonã€compress å‹ç¼©ç­‰åŠŸèƒ½éƒ½æœ‰
  - æ˜¾ç¤ºåˆ†é…ï¼Œè¿™ç®—æ˜¯ Zig çš„å¼ºé¡¹ï¼Œå…¶ä»–è¯­è¨€å¾ˆå°‘æœ‰æ”¯æŒè¿™ä¸ªçš„ï¼Œå› æ­¤ä½œè€…åœ¨è¿™å»ºè®®å¢åŠ ä¸€ç§ç±»ä¼¼ =must-not-allocate= çš„æ³¨è§£ï¼Œ
    è¿™æ ·é«˜çº§è¯­è¨€é‡Œï¼Œä¹Ÿå¯ä»¥ä¿å€¼æŸäº›æ“ä½œä¸ä¼šæœ‰å†…å­˜åˆ†é…ã€‚
- [[https://mtlynch.io/zig-extraneous-build/][Why does an extraneous build step make my Zig app 10x faster?]] :: ä½œè€…åœ¨è¿™ç¯‡æ–‡ç« é‡Œåˆ†äº«äº†è‡ªå·±é‡åˆ°çš„ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜ï¼Œ
  åŒä¸€ä»½ä»£ç ï¼Œæ‰§è¡Œæ–¹å¼ä¸åŒï¼Œç«Ÿç„¶æœ‰ä¸åŒçš„è€—æ—¶ã€‚æœ€å°å¤ç°ä»£ç ï¼š
  #+begin_src zig
// src/main.zig

const std = @import("std");

pub fn countBytes(reader: anytype) !u32 {
    var count: u32 = 0;
    while (true) {
        _ = reader.readByte() catch |err| switch (err) {
            error.EndOfStream => {
                return count;
            },
            else => {
                return err;
            },
        };
        count += 1;
    }
}

pub fn main() !void {
    var reader = std.io.getStdIn().reader();

    var timer = try std.time.Timer.start();
    const start = timer.lap();
    const count = try countBytes(&reader);
    const end = timer.read();
    const elapsed_micros = @as(f64, @floatFromInt(end - start)) / std.time.ns_per_us;

    const output = std.io.getStdOut().writer();
    try output.print("bytes:           {}\n", .{count});
    try output.print("execution time:  {d:.3}Âµs\n", .{elapsed_micros});
}
  #+end_src
  ä¸¤ç§æ‰§è¡Œæ–¹å¼ï¼š
  #+begin_src bash
$ echo '00010203040506070809' | xxd -r -p | zig build run -Doptimize=ReleaseFast
bytes:           10
execution time:  13.549Âµs

$ echo '00010203040506070809' | xxd -r -p | ./zig-out/bin/count-bytes
bytes:           10
execution time:  162.195Âµs
#+end_src
  å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ =zig build run= çš„æ–¹å¼æ¥æ‰§è¡Œæ—¶ï¼Œè€—æ—¶ç›¸æ¯”ç›´æ¥æ‰§è¡Œç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶è¦å¿« 10 å€ã€‚
  é—®é¢˜çš„å…³é”®åœ¨äº shell çš„ pipeline çš„æ‰§è¡Œæœºåˆ¶ï¼Œå¯¹äº =A | B= è¿™æ ·ä¸€ä¸ªç®€å•çš„ pipelineï¼Œä¸€èˆ¬æœ¬èƒ½çš„ä¼šè®¤ä¸º B åªä¼šåœ¨ A
  æ‰§è¡Œå®Œåæ‰å¼€å§‹æ‰§è¡Œï¼Œä½†æ˜¯å®é™…ä¸Šå®ƒä»¬æ˜¯åŒæ—¶è¿è¡Œçš„ï¼Œå› æ­¤ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­é‡Œ =main= å‡½æ•°çš„æ‰§è¡Œæ—¶é—´åœ¨ =zig build run= æ–¹å¼ä¸‹ï¼Œ
  å…¶å®æ‰§è¡Œçš„è¦æ™šä¸€äº›ï¼Œå› ä¸ºå®ƒéœ€è¦å…ˆæ‰§è¡Œç¼–è¯‘æ“ä½œï¼Œå› æ­¤é€ æˆäº†è¿™ä¸ªè¯¯å·®ã€‚
- [[https://neurobug.com/posts/zig/billion/][One Bilion rows in zig]] :: ä½œè€…ç”¨[[https://1brc.dev/][ 1BRC]] è¿™ä¸ªé¡¹ç›®ä½œä¸º Zig çš„ç»ƒæ‰‹é¡¹ç›®ï¼Œé‡Œé¢ç”¨åˆ°äº† [[https://github.com/mstange/samply][mstange/samply]] è¿™ä¸ª Profiler
  å·¥å…·ï¼Œè¿˜èµ·æ¥è¿˜æ¯”è¾ƒå®ç”¨ã€‚
- [[https://matklad.github.io/2024/03/21/defer-patterns.html][Zig defer Patterns]] :: Matklad æœ€æ–°çš„ä¸€ç¯‡æ–‡ç« ï¼ŒZiggit [[https://ziggit.dev/t/zig-defer-patterns/3638/3][è®¨è®ºé“¾æ¥]]ã€‚é‡Œé¢è®²è¿°äº† defer é™¤äº†åšèµ„æºå›æ”¶å¤–ï¼Œå…¶ä»–çš„ä¸€äº›æƒ¯ç”¨æ³•ï¼Œé‡Œé¢æœ‰å‡ ä¸ªæœ‰è¶£çš„ç‚¹ï¼š
  #+begin_src zig
errdefer comptime unreachable
  #+end_src
  æ–‡ä¸­ç§°è¿™ä¸ªæ˜¯ Zig çš„å·…å³°ç”¨æ³•ğŸ˜…ï¼Œ =errdefer unreachable= è¿˜æ¯”è¾ƒå¥½ç†è§£ï¼Œå³åœ¨æ‰§è¡Œå‡ºé”™æ—¶ï¼Œæ‰§è¡Œ unreachable ï¼ŒåŠ ä¸Š comptime å‘¢ï¼Ÿ

  å…¶å®è¿™æ˜¯é˜»æ­¢ Zig ç¼–è¯‘å™¨ç”Ÿäº§é”™è¯¯å¤„ç†çš„ä»£ç ï¼Œå³åœ¨ç¼–è¯‘æ—¶æœŸä¿è¯ä¸‹é¢çš„é€»è¾‘ä¸ä¼šå‡ºé”™ï¼Œç¡®å®ç”¨çš„å¾ˆå·§å¦™ï¼ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š

  #+begin_src zig
const std = @import("std");

test "errdeferWithUnreachable" {
    errdefer comptime unreachable;
    const i = try inc(1);
    try std.testing.expectEqual(i, 2);
}

fn inc(a: i8) !i8 {
    if (a > 10) {
        return error.TooLarge;
    }
    return a + 1;
}
  #+end_src
  ç›´æ¥æ‰§è¡Œ =zig test= ï¼Œåœ¨ç¼–è¯‘æ—¶ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š
#+begin_src shell
test.zig:4:23: error: reached unreachable code
    errdefer comptime unreachable;
#+end_src
è™½ç„¶ =a= æ˜¯ä¸ªè¿è¡Œæ—¶çš„å€¼ï¼Œä½†æ˜¯ =errdefer comptime unreachable= ä¸å…³å¿ƒè¿™ä¸ªï¼Œåªè¦ Zig ç¼–è¯‘å™¨å¼€å§‹ç”Ÿæˆ ErrorSet ç›¸å…³ä»£ç ï¼Œ
ç¼–è¯‘å°±ä¼šæŠ¥é”™ï¼Œå»æ‰ä¸Šé¢çš„ if ä»£ç å—åï¼Œæµ‹è¯•å°±å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼š
- [[https://github.com/ziglang/zig/pull/19364/files][std.hash_map: fix pointer lock safety false positive by andrewrk Â· Pull Request #19364 Â· ziglang/zig]]
#+begin_src diff
   assert(std.math.isPowerOfTwo(new_cap));

   var map: Self = .{};
-  defer map.deinit(allocator);
-  map.pointer_stability.lock();
   try map.allocate(allocator, new_cap);
+  errdefer comptime unreachable;
+  map.pointer_stability.lock();
   map.initMetadatas();
   map.available = @truncate((new_cap * max_load_percentage) / 100);

@@6581,7 @@ pub fn HashMapUnmanaged(
   self.size = 0;
   self.pointer_stability = .{ .state = .unlocked };
   std.mem.swap(Self, self, &map);
+  map.deinit(allocator);

+
+test "getOrPut allocation failure" {
+    var map: std.StringHashMapUnmanaged(void) = .{};
+    try testing.expectError(error.OutOfMemory, map.getOrPut(std.testing.failing_allocator, "hello"));
+}
#+end_src
å¯ä»¥çœ‹åˆ°ï¼Œ è¿™ä¹ˆä¿®æ”¹åï¼Œå°±å¯ä»¥ä¿è¯ =map.deinit(allocator)= è¯­å¥ä¹‹å‰æ²¡æœ‰é”™è¯¯å¯èƒ½äº§ç”Ÿï¼è¯»è€…å¯ä»¥ç»†ç»†å“å‘³ä¸€ä¸‹è¿™ä¸ªç”¨æ³•ã€‚

  å¦ä¸€ä¸ªå°æŠ€å·§æ˜¯ errdefer ç«Ÿç„¶æ”¯æŒé”™è¯¯æ•è·ï¼Œå³ä¸‹é¢è¿™ç§ç”¨æ³•ï¼š
  #+begin_src zig
const port = port: {
    errdefer |err| std.log.err("failed to read the port number: {!}", .{err});
    var buf: [fmt.count("{}\n", .{maxInt(u16)})]u8 = undefined;
    const len = try process.stdout.?.readAll(&buf);
    break :port try fmt.parseInt(u16, buf[0 .. len -| 1], 10);
};
  #+end_src
  - [[https://ziggit.dev/t/build-system-tricks/3531/1][Build system tricks]] :: ä»‹ç»äº† zig build çš„ä½¿ç”¨æŠ€å·§ï¼Œè¿™äº›æŠ€å·§æœ‰åŠ©äºåœ¨ç¡®ä¿æ–¹ä¾¿åœ°å‘½åå’Œå¸ƒå±€æ„å»ºæ­¥éª¤çš„åŒæ—¶ï¼Œå¦‚ä½•ä½¿ç”¨æ„å»ºç³»ç»Ÿçš„æ¯ä¸ªéƒ¨åˆ†ã€‚
  - [[https://blog.mjgrzymek.com/blog/zigwasm][Using Zig with WebAssembly]] :: å¦‚ä½•å°† Zig ç¼–è¯‘æˆ wasmï¼Œå¹¶ä¼ é€’å¤æ‚çš„å‚æ•°ã€‚

* é¡¹ç›®/å·¥å…·
- [[https://github.com/xataio/pgzx][xataio/pgzx]] :: Create PostgreSQL extensions using Zig. ä¸€ä¸ªä¾‹å­ï¼š
  #+begin_src zig
const std = @import("std");
const pgzx = @import("pgzx");

comptime {
    pgzx.PG_MODULE_MAGIC();

    pgzx.PG_FUNCTION_V1("char_count_zig", char_count_zig);
}

fn char_count_zig(input_text: []const u8, target_char: []const u8) !u32 {
    if (target_char.len > 1) {
        return pgzx.elog.Error(@src(), "Target char is more than one byte", .{});
    }

    pgzx.elog.Info(@src(), "input_text: {s}\n", .{input_text});
    pgzx.elog.Info(@src(), "target_char: {s}\n", .{target_char});
    pgzx.elog.Info(@src(), "Target char len: {}\n", .{target_char.len});

    var count: u32 = 0;
    for (input_text) |char| {
        if (char == target_char[0]) {
            count += 1;
        }
    }
    return count;
}
  #+end_src

- [[https://github.com/NoelJacob/zman][Manage Zig installations]] :: åˆåˆåˆå’ä¸€ä¸ª Zig ç®¡ç†å·¥å…·ï¼ŒRust å¼€å‘ã€‚
  #+begin_src bash
zman default latest
zman default master
zman default 0.12.0
  #+end_src

- [[https://github.com/mahdifrmz/qooil][mahdifrmz/qooil]] :: ç”¨ Zig è¯­è¨€ç¼–å†™çš„æ–‡ä»¶ä¼ è¾“è½¯ä»¶
- [[https://github.com/timfayz/pretty][timfayz/pretty]] :: Pretty printer for arbitrary data structures in Zig
- [[https://github.com/liyu1981/zcmd.zig][liyu1981/zcmd.zig]] :: Zcmd is a single file lib to replace zig's std.childProcess.run with the ability of running pipeline like bash.
- [[https://github.com/zigcc/zig-milestone][zigcc/zig-milestone]] :: Zig milstone monitor

* [[https://github.com/ziglang/zig/pulls?page=1&q=+is%3Aclosed+is%3Apr+closed%3A2024-02-01..2024-03-01][Zig è¯­è¨€æ›´æ–°]]
