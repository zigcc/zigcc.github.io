#+TITLE: 202403
#+DATE: 2024-03-13T20:32:27+0800
#+LASTMOD: 2024-03-27T22:40:03+0800
#+DRAFT: true
* é‡å¤§äº‹ä»¶
* è§‚ç‚¹/æ•™ç¨‹
- [[https://github.com/ziglang/zig/pull/19208][Redesign How Autodoc Works]] :: Andrew åœ¨è¿™ä¸ª PR é‡Œé‡æž„äº†çŽ°æœ‰çš„æ–‡æ¡£ç³»ç»Ÿ Autodocï¼Œä¹‹å‰çš„å®žçŽ°é—®é¢˜å¾ˆå¤šã€‚æ¯”å¦‚ï¼š
  - å¾ˆå¤šåŠŸèƒ½é‡å¤çš„æ–‡ä»¶ï¼Œæœ€å¤¸å¼ çš„æ˜¯ =lib/docs/ziglexer.js= ï¼Œå®ƒæ˜¯ç”¨ JS å®žçŽ°çš„ Zig çš„è§£æžå™¨ï¼Œå…¶å®ž Zig å·²ç»åœ¨æ ‡å‡†åº“ä¸­æš´éœ²è§£æžç›¸å…³ APIï¼Œé€šè¿‡ wasm å°±å¯ä»¥è°ƒç”¨
  - åŠŸèƒ½æ›´å¼ºï¼Œå› ä¸ºæ–°è®¾è®¡æ–¹æ¡ˆä¸å†å¤„ç† ZIRï¼Œè€Œæ˜¯ç›´æŽ¥å¤„ç†æºæ–‡ä»¶ï¼Œè¿™æ„å‘³ç€å®ƒæ‹¥æœ‰100% çš„ä¿¡æ¯ï¼Œä¸éœ€è¦å‘åŽæ‹¼å‡‘ä»»ä½•ä¸œè¥¿ã€‚
  - sources.tar æ–‡ä»¶ç» HTTP å±‚è§£åŽ‹åŽï¼Œç›´æŽ¥è¿›å…¥ wasm æ¨¡å—çš„å†…å­˜ã€‚ä½¿ç”¨ std.tar å¯¹ tar æ–‡ä»¶è¿›è¡Œè§£æžï¼Œå¹¶å¯¹æºæ–‡ä»¶è¿›è¡Œå°±åœ°è§£æžï¼ŒåŒæ—¶åœ¨å“ˆå¸Œè¡¨ä¸­æ·»åŠ ä¸€äº›é¢å¤–çš„è®¡ç®—ã€‚è™½ç„¶å¯ä»¥é€šè¿‡ Worker æ¥åŠ å¿«è§£æžé€Ÿåº¦ï¼Œä½†å•çº¿ç¨‹çš„è§£æžé€Ÿåº¦å·²ç»éžå¸¸å¿«ï¼Œå› æ­¤è¿™å¹¶ä¸æ˜¯éžå¸¸æœ‰å¿…è¦ã€‚

    å¿«æ¥ä½“éªŒæœ€æ–°çš„æ–‡æ¡£ç³»ç»Ÿå§ï¼šhttps://ziglang.org/documentation/master/std/
- [[https://notes.eatonphil.com/2024-03-15-zig-rust-and-other-languages.html][Zig, Rust, and other languages]] :: è€æœ‹å‹ Phil Eaton çš„æ–‡ç« ï¼Œåœ¨è¿™é‡Œä»–é’ˆå¯¹ä»¥ä¸‹å‡ ç‚¹è¿›è¡Œäº†è¯­è¨€å¯¹æ¯”ï¼š
  - å†…å­˜ç®¡ç†ã€‚Zig æœ€å¤§çš„é—®é¢˜æ˜¯ä¸æ”¯æŒ RAIIï¼Œä¸€ä¸ªè¿‘ä¼¼çš„æ¦‚å¿µæ˜¯ arenas åˆ†é…å™¨ã€‚
  - æ ‡å‡†åº“ï¼Œä¸»è¦æ˜¯è®¨è®ºæ ‡å‡†åº“æ˜¯å¦åº”è¯¥ç²¾ç®€ä¸ºä¸»ï¼Œ =node_modules= æ˜¯ä¸šç•Œç»å¸¸æåˆ°çš„ä¸€ä¸ªåé¢ä¾‹å­ï¼Œä¸€èˆ¬æ”¯æŒç²¾ç®€çš„äººä¼šè®¤ä¸ºï¼Œ
    - è¯­è¨€çš„ std ä¸å®¹æ˜“å‡ºçŽ° breaking changesï¼Œæƒ³ Python é‡Œå°±æœ‰ urllibã€urllib2ã€urllib3 è¿™ä¸‰ä¸ªç½‘ç»œåº“ï¼Œ
      ä½†æ˜¯ç¤¾åŒºæŽ¨èçš„å¹¶ä¸æ˜¯è¿™ä¸‰ä¸ªï¼Œè€Œæ˜¯ requestsï¼Œè¿™æ · std çš„ä½ç½®å°±æœ‰äº›å°´å°¬
    - Zig ç›®å‰çš„æ ‡å‡†åº“ç®—æ˜¯ä¸­ç­‰å¤§å°ï¼Œjsonã€compress åŽ‹ç¼©ç­‰åŠŸèƒ½éƒ½æœ‰
  - æ˜¾ç¤ºåˆ†é…ï¼Œè¿™ç®—æ˜¯ Zig çš„å¼ºé¡¹ï¼Œå…¶ä»–è¯­è¨€å¾ˆå°‘æœ‰æ”¯æŒè¿™ä¸ªçš„ï¼Œå› æ­¤ä½œè€…åœ¨è¿™å»ºè®®å¢žåŠ ä¸€ç§ç±»ä¼¼ =must-not-allocate= çš„æ³¨è§£ï¼Œ
    è¿™æ ·é«˜çº§è¯­è¨€é‡Œï¼Œä¹Ÿå¯ä»¥ä¿å€¼æŸäº›æ“ä½œä¸ä¼šæœ‰å†…å­˜åˆ†é…ã€‚
- [[https://mtlynch.io/zig-extraneous-build/][Why does an extraneous build step make my Zig app 10x faster?]] :: ä½œè€…åœ¨è¿™ç¯‡æ–‡ç« é‡Œåˆ†äº«äº†è‡ªå·±é‡åˆ°çš„ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜ï¼Œ
  åŒä¸€ä»½ä»£ç ï¼Œæ‰§è¡Œæ–¹å¼ä¸åŒï¼Œç«Ÿç„¶æœ‰ä¸åŒçš„è€—æ—¶ã€‚æœ€å°å¤çŽ°ä»£ç ï¼š
  #+begin_src zig
// src/main.zig

const std = @import("std");

pub fn countBytes(reader: anytype) !u32 {
    var count: u32 = 0;
    while (true) {
        _ = reader.readByte() catch |err| switch (err) {
            error.EndOfStream => {
                return count;
            },
            else => {
                return err;
            },
        };
        count += 1;
    }
}

pub fn main() !void {
    var reader = std.io.getStdIn().reader();

    var timer = try std.time.Timer.start();
    const start = timer.lap();
    const count = try countBytes(&reader);
    const end = timer.read();
    const elapsed_micros = @as(f64, @floatFromInt(end - start)) / std.time.ns_per_us;

    const output = std.io.getStdOut().writer();
    try output.print("bytes:           {}\n", .{count});
    try output.print("execution time:  {d:.3}Âµs\n", .{elapsed_micros});
}
  #+end_src
  ä¸¤ç§æ‰§è¡Œæ–¹å¼ï¼š
  #+begin_src bash
$ echo '00010203040506070809' | xxd -r -p | zig build run -Doptimize=ReleaseFast
bytes:           10
execution time:  13.549Âµs

$ echo '00010203040506070809' | xxd -r -p | ./zig-out/bin/count-bytes
bytes:           10
execution time:  162.195Âµs
#+end_src
  å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ =zig build run= çš„æ–¹å¼æ¥æ‰§è¡Œæ—¶ï¼Œè€—æ—¶ç›¸æ¯”ç›´æŽ¥æ‰§è¡Œç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶è¦å¿« 10 å€ã€‚
  é—®é¢˜çš„å…³é”®åœ¨äºŽ shell çš„ pipeline çš„æ‰§è¡Œæœºåˆ¶ï¼Œå¯¹äºŽ =A | B= è¿™æ ·ä¸€ä¸ªç®€å•çš„ pipelineï¼Œä¸€èˆ¬æœ¬èƒ½çš„ä¼šè®¤ä¸º B åªä¼šåœ¨ A
  æ‰§è¡Œå®ŒåŽæ‰å¼€å§‹æ‰§è¡Œï¼Œä½†æ˜¯å®žé™…ä¸Šå®ƒä»¬æ˜¯åŒæ—¶è¿è¡Œçš„ï¼Œå› æ­¤ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­é‡Œ =main= å‡½æ•°çš„æ‰§è¡Œæ—¶é—´åœ¨ =zig build run= æ–¹å¼ä¸‹ï¼Œ
  å…¶å®žæ‰§è¡Œçš„è¦æ™šä¸€äº›ï¼Œå› ä¸ºå®ƒéœ€è¦å…ˆæ‰§è¡Œç¼–è¯‘æ“ä½œï¼Œå› æ­¤é€ æˆäº†è¿™ä¸ªè¯¯å·®ã€‚
- [[https://neurobug.com/posts/zig/billion/][One Bilion rows in zig]] :: ä½œè€…ç”¨[[https://1brc.dev/][ 1BRC]] è¿™ä¸ªé¡¹ç›®ä½œä¸º Zig çš„ç»ƒæ‰‹é¡¹ç›®ï¼Œé‡Œé¢ç”¨åˆ°äº† [[https://github.com/mstange/samply][mstange/samply]] è¿™ä¸ª Profiler
  å·¥å…·ï¼Œè¿˜èµ·æ¥è¿˜æ¯”è¾ƒå®žç”¨ã€‚
- [[https://matklad.github.io/2024/03/21/defer-patterns.html][Zig defer Patterns]] :: Matklad æœ€æ–°çš„ä¸€ç¯‡æ–‡ç« ï¼Œé‡Œé¢è®²è¿°äº† defer é™¤äº†åšèµ„æºå›žæ”¶å¤–ï¼Œå…¶ä»–çš„ä¸€äº›æƒ¯ç”¨æ³•ï¼Œé‡Œé¢æœ‰å‡ ä¸ªæœ‰è¶£çš„ç‚¹ï¼š
  #+begin_src zig
errdefer comptime unreachable
  #+end_src
  æ–‡ä¸­ç§°è¿™ä¸ªæ˜¯ Zig çš„å·…å³°ç”¨æ³•ðŸ˜…ï¼Œ =errdefer unreachable= è¿˜æ¯”è¾ƒå¥½ç†è§£ï¼Œå³åœ¨æ‰§è¡Œå‡ºé”™æ—¶ï¼Œæ‰§è¡Œ unreachable ï¼ŒåŠ ä¸Š comptime å‘¢ï¼Ÿå…¶å®žè¿™æ˜¯é˜»æ­¢ Zig ç¼–è¯‘å™¨ç”Ÿäº§é”™è¯¯å¤„ç†çš„ä»£ç ï¼Œå³åœ¨ç¼–è¯‘æ—¶æœŸä¿è¯ä¸‹é¢çš„é€»è¾‘ä¸ä¼šå‡ºé”™ï¼Œç¡®å®žç”¨çš„å¾ˆå·§å¦™ï¼ä¸€ä¸ªå¾ˆå¥½çš„ç¤ºä¾‹ï¼š[[https://github.com/ziglang/zig/pull/19364/files][std.hash_map: fix pointer lock safety false positive by andrewrk Â· Pull Request #19364 Â· ziglang/zig]]

  å¦ä¸€ä¸ªå°æŠ€å·§æ˜¯ errdefer ç«Ÿç„¶æ”¯æŒé”™è¯¯æ•èŽ·ï¼Œå³ä¸‹é¢è¿™ç§ç”¨æ³•ï¼š
  #+begin_src zig
const port = port: {
    errdefer |err| std.log.err("failed to read the port number: {!}", .{err});
    var buf: [fmt.count("{}\n", .{maxInt(u16)})]u8 = undefined;
    const len = try process.stdout.?.readAll(&buf);
    break :port try fmt.parseInt(u16, buf[0 .. len -| 1], 10);
};
  #+end_src

* é¡¹ç›®/å·¥å…·
- [[https://github.com/xataio/pgzx][xataio/pgzx]] :: Create PostgreSQL extensions using Zig. ä¸€ä¸ªä¾‹å­ï¼š
  #+begin_src zig
const std = @import("std");
const pgzx = @import("pgzx");

comptime {
    pgzx.PG_MODULE_MAGIC();

    pgzx.PG_FUNCTION_V1("char_count_zig", char_count_zig);
}

fn char_count_zig(input_text: []const u8, target_char: []const u8) !u32 {
    if (target_char.len > 1) {
        return pgzx.elog.Error(@src(), "Target char is more than one byte", .{});
    }

    pgzx.elog.Info(@src(), "input_text: {s}\n", .{input_text});
    pgzx.elog.Info(@src(), "target_char: {s}\n", .{target_char});
    pgzx.elog.Info(@src(), "Target char len: {}\n", .{target_char.len});

    var count: u32 = 0;
    for (input_text) |char| {
        if (char == target_char[0]) {
            count += 1;
        }
    }
    return count;
}
  #+end_src


* [[https://github.com/ziglang/zig/pulls?page=1&q=+is%3Aclosed+is%3Apr+closed%3A2024-02-01..2024-03-01][Zig è¯­è¨€æ›´æ–°]]
