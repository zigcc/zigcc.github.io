---
.title = "在0.15.2版本使用C ABI模拟Zig ABI",
.date = @date("2026-01-18T21:05:00+0800"),
.author = "艾达爱白糖",
.layout = "post.shtml",
.draft = false,
.custom = {
  .mermaid = true,
},
---

白糖：艾达，我怎么才能把我的zig项目发布出去，但是不公开源码呀？

艾达：可以分发二进制库文件和相关头文件，照着这样写就行了。

```zig
// lib.zig
pub const Container = extern struct {
    value: c_int,

    pub export fn foo(self: *@This()) callconv(.c) void {
        // ...
    }
};

// project.zig
pub const Container = extern struct {
    value: c_int,

    pub extern fn foo(self: *@This()) callconv(.c) void;
};
```

白糖：导出为C库呀。但是你这就一个结构，一个函数，这么写当然没什么问题，如果有很多函数，结构呢？

艾达：别忘了zig的`comptime`机制呀，编译时可以自动导出和生成头文件。

```zig
// lib.zig
pub const Container = extern struct {
    value: c_int,

    pub export fn foo(self: *@This()) callconv(.c) void {
        // ...
    }
};

comptime {
    exports(Container);
}

fn exports(Target: type) void {
    const info = @typeInfo(Target);

    inline for (info.@"struct".decls) |decl| {
        const field = @field(Target, decl.name);
        const field_type = @TypeOf(field);
        const field_type_info = @typeInfo(field_type);

        if (field_type_info == .@"fn") {
            @export(&field, .{ .name = decl.name });
        }
    }
}
```

艾达：如果结构内还有类型定义，可以递归调用，这样就只需要传最外层的类型。怕参数错误，可以在导出前做各种检测来避免。注意这个方法需要函数标记`pub`以及不需要标记`export`。对于`extern union`和`enum(c_int)`也是相似的。

白糖：这里只有导出，那头文件怎么自动生成。而且编译时必须是常量，如果可以把调用了`exports`的类型都收集起来给运行时用就好了。艾达，有什么办法吗？

艾达：编译时收集有些困难。不过办法还是有的，如果`exports`在编译时和生成头文件时是不同的函数是不是就可以解决了。接下来就是zig构建系统的事情，我们要利用其module机制。

艾达：首先我们把项目分成四部分，分别是库本身、编译时导出符号模块、运行生成头文件模块和运行生成头文件的主函数。

```zig
// lib.zig
const export_mod = @import("export_mod");

pub const ExportedContainer = extern struct {
    value: c_int,

    pub export fn foo(self: *@This()) callconv(.c) void {
        // ...
    }
};

comptime {
    if (export_mod.export_mode) {
        exportAllSymbol();
    }
}

pub fn exportAllSymbol() void {
    export_mod.exportsymbols(ExportedContainer);
}

// export_symbol.zig
pub const export_mode = true;

pub fn exportsymbols(Target: type) void {
    // ...

    @export(..., ...) ;

    // ...
}

// gen_header.zig
pub const export_mode = false;

pub fn exportsymbols(Target: type) void {
    genHeader(Target);
}

// gen_header_main.zig
const lib = @import("lib");

fn main() void {
    lib.exportAllSymbol();
}
```

艾达：最后在build.zig中创建依赖。
```zig
// build.zig
pub fn build2(b: *std.Build) void {
    const target = b.standardTargetOptions(.{});
    const optimize = b.standardOptimizeOption(.{});

    // 构建库以及导出符号
    const symbol_mod = b.createModule(
        .{
            .root_source_file = b.path("export_symbol.zig"),
            .target = target,
            .optimize = optimize,
        },
    );

    const lib = b.createModule(
        .{
            .root_source_file = b.path("lib.zig"),
            .target = target,
            .optimize = optimize,
            .imports = &.{
                .{
                    .name = "export_mod",
                    .module = symbol_mod,
                },
            },
        },
    );

    const lib_builder = b.addLibrary(.{
        .name = "lib",
        .root_module = lib,
    });

    b.installArtifact(lib_builder);

    // 生成头文件
    const gen_mod = b.createModule(
        .{
            .root_source_file = b.path("gen_header.zig"),
            .target = target,
            .optimize = optimize,
        },
    );

    const gen_header_lib = b.createModule(
        .{
            .root_source_file = b.path("lib.zig"),
            .target = target,
            .optimize = optimize,
            .imports = &.{
                .{
                    .name = "export_mod", //注意名字需要相同
                    .module = gen_mod,
                },
            },
        },
    );

    const gen_mode = b.createModule(
        .{
            .root_source_file = b.path("gen_header_main.zig"),
            .target = target,
            .optimize = optimize,
            .imports = &.{
                .{
                    .name = "lib", // 与 gen_header_main 中对应
                    .module = gen_header_lib,
                },
            },
        },
    );

    const run = b.addRunArtifact(b.addExecutable(.{
        .name = "gen_main",
        .root_module = gen_mode,
    }));

    b.getInstallStep().dependOn(&run.step);
}
```

```=html
<svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="0 -49.79999923706055 356.41253662109375 479.79998779296875" style="max-width: 356.41253662109375px;" class="flowchart" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-e526e86a-eb46-44f0-922d-d06690718253"><style>#mermaid-e526e86a-eb46-44f0-922d-d06690718253{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .error-icon{fill:#a44141;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edge-thickness-normal{stroke-width:1px;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .marker.cross{stroke:lightgrey;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 p{margin:0;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .cluster-label text{fill:#F9FFFE;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .cluster-label span{color:#F9FFFE;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .cluster-label span p{background-color:transparent;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .label text,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 span{fill:#ccc;color:#ccc;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .node rect,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .node circle,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .node ellipse,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .node polygon,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .rough-node .label text,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .node .label text,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .image-shape .label,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .icon-shape .label{text-anchor:middle;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .rough-node .label,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .node .label,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .image-shape .label,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .icon-shape .label{text-align:center;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .node.clickable{cursor:pointer;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .arrowheadPath{fill:lightgrey;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .cluster text{fill:#F9FFFE;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .cluster span{color:#F9FFFE;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 rect.text{fill:none;stroke-width:0;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .icon-shape,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .icon-shape p,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .icon-shape rect,#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#mermaid-e526e86a-eb46-44f0-922d-d06690718253 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-e526e86a-eb46-44f0-922d-d06690718253_flowchart-v2-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="8" markerWidth="8" markerUnits="userSpaceOnUse" refY="5" refX="4.5" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-e526e86a-eb46-44f0-922d-d06690718253_flowchart-v2-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-e526e86a-eb46-44f0-922d-d06690718253_flowchart-v2-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart-v2" id="mermaid-e526e86a-eb46-44f0-922d-d06690718253_flowchart-v2-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-e526e86a-eb46-44f0-922d-d06690718253_flowchart-v2-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart-v2" id="mermaid-e526e86a-eb46-44f0-922d-d06690718253_flowchart-v2-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid-e526e86a-eb46-44f0-922d-d06690718253_flowchart-v2-pointEnd)" data-points="W3sieCI6ODIuNTI1MDAxNTI1ODc4OSwieSI6NjJ9LHsieCI6ODIuNTI1MDAxNTI1ODc4OSwieSI6ODd9LHsieCI6ODIuNTI1MDAxNTI1ODc4OSwieSI6MTEyfV0=" data-id="L_build1_lib1_0" data-et="edge" data-edge="true" style=";" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_build1_lib1_0" d="M82.525,62L82.525,66.167C82.525,70.333,82.525,78.667,82.525,86.333C82.525,94,82.525,101,82.525,104.5L82.525,108"></path><path data-points="W3sieCI6ODIuNTI1MDAxNTI1ODc4OSwieSI6MTY2fSx7IngiOjgyLjUyNTAwMTUyNTg3ODksInkiOjIwM30seyJ4Ijo4Mi41MjUwMDE1MjU4Nzg5LCJ5IjoyNDB9XQ==" data-id="L_lib1_symbol_mod_0" data-et="edge" data-edge="true" style=";" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_lib1_symbol_mod_0" d="M82.525,166L82.525,172.167C82.525,178.333,82.525,190.667,82.525,203C82.525,215.333,82.525,227.667,82.525,233.833L82.525,240"></path><path marker-end="url(#mermaid-e526e86a-eb46-44f0-922d-d06690718253_flowchart-v2-pointEnd)" data-points="W3sieCI6MjYwLjAxODc1MzA1MTc1NzgsInkiOjYyfSx7IngiOjI2MC4wMTg3NTMwNTE3NTc4LCJ5Ijo4N30seyJ4IjoyNjAuMDE4NzUzMDUxNzU3OCwieSI6MTEyfV0=" data-id="L_gen_header_gen_mode_main_0" data-et="edge" data-edge="true" style=";" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_gen_header_gen_mode_main_0" d="M260.019,62L260.019,66.167C260.019,70.333,260.019,78.667,260.019,86.333C260.019,94,260.019,101,260.019,104.5L260.019,108"></path><path data-points="W3sieCI6MjYwLjAxODc1MzA1MTc1NzgsInkiOjI5NH0seyJ4IjoyNjAuMDE4NzUzMDUxNzU3OCwieSI6MzMxfSx7IngiOjI2MC4wMTg3NTMwNTE3NTc4LCJ5IjozNjh9XQ==" data-id="L_lib_gen_mode_0" data-et="edge" data-edge="true" style=";" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_lib_gen_mode_0" d="M260.019,294L260.019,300.167C260.019,306.333,260.019,318.667,260.019,331C260.019,343.333,260.019,355.667,260.019,361.833L260.019,368"></path><path data-points="W3sieCI6MjYwLjAxODc1MzA1MTc1NzgsInkiOjE2Nn0seyJ4IjoyNjAuMDE4NzUzMDUxNzU3OCwieSI6MjAzfSx7IngiOjI2MC4wMTg3NTMwNTE3NTc4LCJ5IjoyNDB9XQ==" data-id="L_gen_mode_main_lib_0" data-et="edge" data-edge="true" style=";" class="edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link" id="L_gen_mode_main_lib_0" d="M260.019,166L260.019,172.167C260.019,178.333,260.019,190.667,260.019,203C260.019,215.333,260.019,227.667,260.019,233.833L260.019,240"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" data-id="L_build1_lib1_0" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g transform="translate(82.5250015258789, 203)" class="edgeLabel"><g transform="translate(-16, -12)" data-id="L_lib1_symbol_mod_0" class="label"><foreignObject height="24" width="32"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>依赖</p></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" data-id="L_gen_header_gen_mode_main_0" class="label"><foreignObject height="0" width="0"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g transform="translate(260.0187530517578, 331)" class="edgeLabel"><g transform="translate(-16, -12)" data-id="L_lib_gen_mode_0" class="label"><foreignObject height="24" width="32"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>依赖</p></span></div></foreignObject></g></g><g transform="translate(260.0187530517578, 203)" class="edgeLabel"><g transform="translate(-16, -12)" data-id="L_gen_mode_main_lib_0" class="label"><foreignObject height="24" width="32"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" class="labelBkg" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"><p>依赖</p></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(82.5250015258789, 35)" id="flowchart-build1-0" class="node default"><rect height="54" width="95.86249923706055" y="-27" x="-47.93124961853027" style="" class="basic label-container"></rect><g transform="translate(-17.931249618530273, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="35.86249923706055"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>build</p></span></div></foreignObject></g></g><g transform="translate(82.5250015258789, 139)" id="flowchart-lib1-1" class="node default"><rect height="54" width="78.20000076293945" y="-27" x="-39.10000038146973" style="" class="basic label-container"></rect><g transform="translate(-9.100000381469727, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="18.200000762939453"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>lib</p></span></div></foreignObject></g></g><g transform="translate(82.5250015258789, 267)" id="flowchart-symbol_mod-3" class="node default"><rect height="54" width="149.0500030517578" y="-27" x="-74.5250015258789" style="" class="basic label-container"></rect><g transform="translate(-44.525001525878906, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="89.05000305175781"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>symbol_mod</p></span></div></foreignObject></g></g><g transform="translate(260.0187530517578, 35)" id="flowchart-gen_header-4" class="node default"><rect height="54" width="143.625" y="-27" x="-71.8125" style="" class="basic label-container"></rect><g transform="translate(-41.8125, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="83.625"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>gen_header</p></span></div></foreignObject></g></g><g transform="translate(260.0187530517578, 139)" id="flowchart-gen_mode_main-5" class="node default"><rect height="54" width="176.7874984741211" y="-27" x="-88.39374923706055" style="" class="basic label-container"></rect><g transform="translate(-58.39374923706055, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="116.7874984741211"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>gen_mode_main</p></span></div></foreignObject></g></g><g transform="translate(260.0187530517578, 267)" id="flowchart-lib-6" class="node default"><rect height="54" width="78.20000076293945" y="-27" x="-39.10000038146973" style="" class="basic label-container"></rect><g transform="translate(-9.100000381469727, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="18.200000762939453"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>lib</p></span></div></foreignObject></g></g><g transform="translate(260.0187530517578, 395)" id="flowchart-gen_mode-7" class="node default"><rect height="54" width="133.4000015258789" y="-27" x="-66.70000076293945" style="" class="basic label-container"></rect><g transform="translate(-36.70000076293945, -12)" style="" class="label"><rect></rect><foreignObject height="24" width="73.4000015258789"><div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"><p>gen_mode</p></span></div></foreignObject></g></g></g></g></g><text class="flowchartTitleText" y="-25" x="178.20626831054688" text-anchor="middle">build.zig</text></svg>
```

艾达：现在完成了构建库时自动生成头文件了，实现了分享zig库不公开源码的功能。因为用C ABI所以会有一些限制，例如zig标准库的一些类型不能导出，需要实现C版本的。

艾达：具体生成的函数这里省略了，就是递归类型的`decls`和`fields`字段根据类型输出相应文本。不过zig的`Type`有些限制，生成会有些不完美，比如函数信息就没有参数名，`struct`内的`union`字段不知道初始化的哪个变体等。

白糖：太好了，有什么例子可以看看吗？

艾达：当然！
```zig
// lib
pub const Color = extern struct {
    r: u8,
    g: u8,
    b: u8,
    a: u8 = 255,

    pub fn init(color: @Vector(4, u8)) callconv(.c) @This() {
        return .{
            .r = color[0],
            .g = color[1],
            .b = color[2],
            .a = color[3],
        };
    }
};

// header
pub const Color = extern struct {
    r : u8 align(1),
    g : u8 align(1),
    b : u8 align(1),
    a : u8 align(1) = 255,
    extern fn main_Color_init(@Vector(4, u8)) callconv(.c) @This();
};
```

艾达：对了，如果不想在构建库时自动生成头文件可以修改build.zig。

```zig
    // ...

    // b.getInstallStep().dependOn(&run.step);
    const run_step = b.step("gen_main", "generate the header.");
    run_step.dependOn(&run.step);

    // ...
```

艾达：在命令行运行`zig build gen_main`就可以单独生成了。

白糖：太好了，爱你！艾达。