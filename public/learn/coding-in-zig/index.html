<!DOCTYPE html>
<html>
  <head id="head">
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1">
    <meta name="description" content="Zig Chinese Community is dedicated to sharing and spreading the use of Zig language among Chinese users.">
    <title>Zig 语言中文社区</title>
    <link type="text/css" rel="stylesheet" href="/style.css">
    <link type="text/css" rel="stylesheet" href="/highlight.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- TODO replace this -->
    
  <link type="text/css" rel="stylesheet" href="/style.css">

  </head>
  <body id="body">
    <div class="header">
      <a href="/" class="site-title"><h1>Zig 语言中文社区</h1></a>
      <nav>
        <a href="/learn/">学习 Zig</a>
         &nbsp; • &nbsp;
        <a href="/monthly/">月刊</a>
         &nbsp; • &nbsp;
        <a href="/post/">博客</a>
         &nbsp; • &nbsp;
        <a href="/contributing/">贡献</a>
         &nbsp; • &nbsp;
        <a href="/community/">社区</a>
      </nav>
    </div>
    
  <!-- TODO: 根据页面内容长度决定是否显示 TOC -->
  <div class="docs">
    <!-- TODO: 层级 h1 -->
    <h1>Table of Contents</h1>
    <div><ul>
<li>悬空指针 Dangling Pointers</li><li>所有权 Ownership</li><li>ArrayList</li><li>Anytype</li><li>@TypeOf</li><li>构建系统</li><li>第三方依赖</ul></div>
  </div>
  <div class="content"><blockquote><p>原文地址：<a href="https://www.openmymind.net/learning_zig/coding_in_zig" target="_blank">https://www.openmymind.net/learning_zig/coding_in_zig</a></p></blockquote><p>在介绍了 Zig 语言的大部分内容之后，我们将对一些主题进行回顾，并展示几种使用 Zig 编程时一些实用的技巧。在此过程中，我们将介绍更多的标准库，并介绍一些稍复杂些的代码片段。</p><h1>悬空指针 Dangling Pointers</h1><p>我们首先来看看更多关于悬空指针的例子。这似乎是一个奇怪的问题，但如果你之前主要使用带垃圾回收的语言，这可能是你学习 Zig 最大的障碍。</p><p>你能猜到下面的输出是什么吗？</p><pre><code class="zig"><span class="keyword">const</span> <span class="module constant variable_builtin type variable">std</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="keyword_modifier">pub</span> <span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">main</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span> <span class="operator">!</span><span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
	<span class="keyword">var</span> <span class="constant variable_builtin type variable">gpa</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">heap</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">GeneralPurposeAllocator</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">allocator</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">gpa</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">allocator</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">var</span> <span class="constant variable_builtin type variable">lookup</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">StringHashMap</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">User</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">init</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">allocator</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">defer</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">deinit</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">const</span> <span class="constant variable_builtin type variable">goku</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">User</span><span class="punctuation_bracket">{</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">power</span> <span class="operator">=</span> <span class="number">9001</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>

	<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">put</span><span class="punctuation_bracket">(</span><span class="string">&quot;Goku&quot;</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">goku</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="comment_documentation comment spell">// returns an optional, .? would panic if &quot;Goku&quot;</span>
	<span class="comment_documentation comment spell">// wasn&apos;t in our hashmap</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">entry</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">getPtr</span><span class="punctuation_bracket">(</span><span class="string">&quot;Goku&quot;</span><span class="punctuation_bracket">)</span><span class="operator">.?</span><span class="punctuation_delimiter">;</span>

	<span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">debug</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">print</span><span class="punctuation_bracket">(</span><span class="string">&quot;Goku&apos;s power is: {d}</span><span class="string string_escape">\n</span><span class="string">&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="constant variable_builtin type variable">entry</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">power</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="comment_documentation comment spell">// returns true/false depending on if the item was removed</span>
	<span class="constant variable_builtin type variable">_</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">remove</span><span class="punctuation_bracket">(</span><span class="string">&quot;Goku&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">debug</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">print</span><span class="punctuation_bracket">(</span><span class="string">&quot;Goku&apos;s power is: {d}</span><span class="string string_escape">\n</span><span class="string">&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="constant variable_builtin type variable">entry</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">power</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>

<span class="keyword">const</span> <span class="constant variable_builtin type variable">User</span> <span class="operator">=</span> <span class="keyword_type">struct</span> <span class="punctuation_bracket">{</span>
	<span class="constant variable_builtin type variable_member variable">power</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">i32</span><span class="punctuation_delimiter">,</span>
<span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>当我运行这个程序时，我得到了</p><pre><code class="bash"><span class="constant function">Goku</span><span class="string constant function">&apos;s power is: 9001
Goku&apos;</span><span class="constant function">s</span> <span class="constant">power</span> <span class="constant">is:</span> <span class="constant">-1431655766</span>
</code></pre>
<p>这段代码引入了 Zig 的 <code>std.StringHashMap</code>，它是 <code>std.AutoHashMap</code> 的特定版本，键类型设置为 <code>[]const u8</code>。即使你不能百分百确定发生了什么，也可以猜测我的输出与我们从 <code>lookup</code> 中删除条目后的第二次打印有关。注释掉删除的调用，输出就正常了。</p><p>理解上述代码的关键在于了解数据在内存的中位置，或者换句话说，了解数据的所有者。请记住，Zig 参数是按值传递的，也就是说，我们传递的是值的浅副本。我们 <code>lookup</code> 中的 <code>User</code> 与 <code>goku</code> 引用的内存不同。我们上面的代码有两个用户，每个用户都有自己的所有者。<code>goku</code> 的所有者是 <code>main</code>，而它的副本的所有者是 <code>lookup</code>。</p><p><code>getPtr</code> 方法返回的是指向 <code>map</code> 中值的指针，在我们的例子中，它返回的是 <code>*User</code>。问题就在这里，删除会使我们的 <code>entry</code>指针失效。在这个示例中，<code>getPtr</code> 和 <code>remove</code> 的位置很近，因此问题也很明显。但不难想象，代码在调用 <code>remove</code> 时，并不知道 <code>entry</code> 的引用被保存在其他地方了。</p><blockquote><p>在编写这个示例时，我并不确定会发生什么。删除有可能是通过设置内部标志来实现的，实际删除是惰性的。如果是这样的话，上面的示例在简单的情况下可能会 “奏效”，但在更复杂的情况下就会失败。这听起来非常难以调试。</p></blockquote><p>除了不调用 <code>remove</code> 之外，我们还可以用几种不同的方法来解决这个问题。首先，我们可以使用 <code>get</code> 而不是 <code>getPtr</code>。这样 <code>lookup</code> 将返回一个 <code>User</code> 的副本，而不再是 <code>*User</code>。这样我们就有了三个用户：</p><ol><li>定义在函数内部的 <code>goku</code>，<code>main</code> 函数是其所有者</li><li>调用 <code>lookup.put</code> 时，形式参数会得到 <code>goku</code> 一个的副本，<code>lookup</code> 是其所有者</li><li>使用 <code>get</code> 函数返回的 <code>entry</code>，<code>main</code> 函数是其所有者</li></ol><p>由于 <code>entry</code> 现在是 <code>User</code> 的独立副本，因此将其从 <code>lookup</code> 中删除不会再使其失效。</p><p>另一种方法是将 <code>lookup</code> 的类型从 <code>StringHashMap(User)</code> 改为 <code>StringHashMap(*const User)</code>。这段代码可以工作：</p><pre><code class="zig"><span class="keyword">const</span> <span class="module constant variable_builtin type variable">std</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="keyword_modifier">pub</span> <span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">main</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span> <span class="operator">!</span><span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
	<span class="keyword">var</span> <span class="constant variable_builtin type variable">gpa</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">heap</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">GeneralPurposeAllocator</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">allocator</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">gpa</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">allocator</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="comment_documentation comment spell">// User -&gt; *const User</span>
	<span class="keyword">var</span> <span class="constant variable_builtin type variable">lookup</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">StringHashMap</span><span class="punctuation_bracket">(</span><span class="operator">*</span><span class="keyword">const</span> <span class="constant variable_builtin type variable">User</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">init</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">allocator</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">defer</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">deinit</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">const</span> <span class="constant variable_builtin type variable">goku</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">User</span><span class="punctuation_bracket">{</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">power</span> <span class="operator">=</span> <span class="number">9001</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>

	<span class="comment_documentation comment spell">// goku -&gt; &amp;goku</span>
	<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">put</span><span class="punctuation_bracket">(</span><span class="string">&quot;Goku&quot;</span><span class="punctuation_delimiter">,</span> <span class="operator">&amp;</span><span class="constant variable_builtin type variable">goku</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="comment_documentation comment spell">// getPtr -&gt; get</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">entry</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">get</span><span class="punctuation_bracket">(</span><span class="string">&quot;Goku&quot;</span><span class="punctuation_bracket">)</span><span class="operator">.?</span><span class="punctuation_delimiter">;</span>

	<span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">debug</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">print</span><span class="punctuation_bracket">(</span><span class="string">&quot;Goku&apos;s power is: {d}</span><span class="string string_escape">\n</span><span class="string">&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="constant variable_builtin type variable">entry</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">power</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="constant variable_builtin type variable">_</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">remove</span><span class="punctuation_bracket">(</span><span class="string">&quot;Goku&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">debug</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">print</span><span class="punctuation_bracket">(</span><span class="string">&quot;Goku&apos;s power is: {d}</span><span class="string string_escape">\n</span><span class="string">&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="constant variable_builtin type variable">entry</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">power</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>

<span class="keyword">const</span> <span class="constant variable_builtin type variable">User</span> <span class="operator">=</span> <span class="keyword_type">struct</span> <span class="punctuation_bracket">{</span>
	<span class="constant variable_builtin type variable_member variable">power</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">i32</span><span class="punctuation_delimiter">,</span>
<span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>上述代码中有许多微妙之处。首先，我们现在只有一个用户 <code>goku</code>。<code>lookup</code> 和 <code>entry</code> 中的值都是对 <code>goku</code> 的引用。我们对 <code>remove</code> 的调用仍然会删除 <code>lookup</code> 中的值，但该值只是 <code>user</code> 的地址，而不是 <code>user</code> 本身。如果我们坚持使用 <code>getPtr</code>，那么被 <code>remove</code> 后，我们就会得到一个无效的 <code>**User</code>。在这两种解决方案中，我们都必须使用 <code>get</code> 而不是 <code>getPtr</code>，但在这种情况下，我们只是复制地址，而不是完整的 <code>User</code>。对于占用内存较多的对象来说，这可能是一个很大的区别。</p><p>如果把所有东西都放在一个函数中，再加上一个像 <code>User</code> 这样的小值，这仍然像是一个人为制造的问题。我们需要一个能让数据所有权成为当务之急的例子。</p><h1>所有权 Ownership</h1><p>我喜欢哈希表（HashMap），因为这是每个人都知道并且会经常使用的结构。它们有很多不同的用例，其中大部分你可能都用过。虽然哈希表可以用在一个短期查找的地方，但通常用于长期查找，因此插入其内的值需要同样长的生命周期。</p><p>这段代码将使用终端中输入的名称来填充我们的 <code>lookup</code>。如果名字为空，就会停止提示循环。最后，它会检测 <code>Leto</code> 是否出现在 <code>lookup</code> 中。</p><pre><code class="zig"><span class="keyword">const</span> <span class="module constant variable_builtin type variable">std</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="keyword">const</span> <span class="module constant variable_builtin type variable">builtin</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;builtin&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="keyword_modifier">pub</span> <span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">main</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span> <span class="operator">!</span><span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
	<span class="keyword">var</span> <span class="constant variable_builtin type variable">gpa</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">heap</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">GeneralPurposeAllocator</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">allocator</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">gpa</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">allocator</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">var</span> <span class="constant variable_builtin type variable">lookup</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">StringHashMap</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">User</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">init</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">allocator</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">defer</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">deinit</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="comment_documentation comment spell">// stdin is an std.io.Reader</span>
	<span class="comment_documentation comment spell">// the opposite of an std.io.Writer, which we already saw</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">stdin</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">io</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">getStdIn</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">reader</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="comment_documentation comment spell">// stdout is an std.io.Writer</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">stdout</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">io</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">getStdOut</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">writer</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">var</span> <span class="constant variable_builtin type variable">i</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">i32</span> <span class="operator">=</span> <span class="number">0</span><span class="punctuation_delimiter">;</span>
	<span class="keyword_repeat">while</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">true</span><span class="punctuation_bracket">)</span> <span class="punctuation_delimiter">:</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">i</span> <span class="operator">+=</span> <span class="number">1</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket">{</span>
		<span class="keyword">var</span> <span class="constant variable_builtin type variable">buf</span><span class="punctuation_delimiter">:</span> <span class="punctuation_bracket">[</span><span class="number">30</span><span class="punctuation_bracket">]</span><span class="type_builtin">u8</span> <span class="operator">=</span> <span class="constant_builtin">undefined</span><span class="punctuation_delimiter">;</span>
		<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">stdout</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">print</span><span class="punctuation_bracket">(</span><span class="string">&quot;Please enter a name: &quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">stdin</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">readUntilDelimiterOrEof</span><span class="punctuation_bracket">(</span><span class="operator">&amp;</span><span class="constant variable_builtin type variable">buf</span><span class="punctuation_delimiter">,</span> <span class="character">&apos;</span><span class="character string_escape">\n</span><span class="character">&apos;</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket operator">|</span><span class="constant variable_builtin type variable">line</span><span class="punctuation_bracket operator">|</span> <span class="punctuation_bracket">{</span>
			<span class="keyword">var</span> <span class="constant variable_builtin type variable">name</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">line</span><span class="punctuation_delimiter">;</span>
			<span class="comment_documentation comment spell">// Windows平台换行以`\r\n`结束</span>
			<span class="comment_documentation comment spell">// 所以需要截取\r以获取控制台输入字符</span>
			<span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">builtin</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">os</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">tag</span> <span class="operator">==</span> <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable">windows</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket">{</span>
			    <span class="module constant variable_builtin type variable">name</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@constCast</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">mem</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">trimRight</span><span class="punctuation_bracket">(</span><span class="type_builtin">u8</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">name</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;</span><span class="string string_escape">\r</span><span class="string">&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
			<span class="punctuation_bracket">}</span>

			<span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">name</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">len</span> <span class="operator">==</span> <span class="number">0</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket">{</span>
				<span class="keyword_repeat">break</span><span class="punctuation_delimiter">;</span>
			<span class="punctuation_bracket">}</span>
			<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">put</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">name</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">power</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">i</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="punctuation_bracket">}</span>
	<span class="punctuation_bracket">}</span>

	<span class="keyword">const</span> <span class="constant variable_builtin type variable">has_leto</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">contains</span><span class="punctuation_bracket">(</span><span class="string">&quot;Leto&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">debug</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">print</span><span class="punctuation_bracket">(</span><span class="string">&quot;{any}</span><span class="string string_escape">\n</span><span class="string">&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="constant variable_builtin type variable">has_leto</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>

<span class="keyword">const</span> <span class="constant variable_builtin type variable">User</span> <span class="operator">=</span> <span class="keyword_type">struct</span> <span class="punctuation_bracket">{</span>
	<span class="constant variable_builtin type variable_member variable">power</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">i32</span><span class="punctuation_delimiter">,</span>
<span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>上述代码虽然区分大小写，但无论我们如何完美地输入 <code>Leto</code>，<code>contains</code> 总是返回 <code>false</code>。让我们通过遍历 <code>lookup</code> 打印其值来调试一下：</p><pre><code class="zig"><span class="comment_documentation comment spell">// 将这段代码放在 while 循环之后</span>

<span class="keyword">var</span> <span class="constant variable_builtin type variable">it</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">iterator</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="keyword_repeat">while</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">it</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">next</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket operator">|</span><span class="constant variable_builtin type variable">kv</span><span class="punctuation_bracket operator">|</span> <span class="punctuation_bracket">{</span>
	<span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">debug</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">print</span><span class="punctuation_bracket">(</span><span class="string">&quot;{s} == {any}</span><span class="string string_escape">\n</span><span class="string">&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="constant variable_builtin type variable">kv</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">key_ptr</span><span class="operator">.*</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">kv</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">value_ptr</span><span class="operator">.*</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>

</code></pre>
<p>这种迭代器模式在 Zig 中很常见，它依赖于 while 和可选类型（<code>Optional</code>）之间的协同作用。我们的迭代器返回指向键和值的指针，因此我们用 <code>.*</code> 对它们进行反引用，以访问实际值而不是地址。输出结果将取决于你输入的内容，但我得到的是</p><pre><code class="bash"><span class="constant function">Please</span> <span class="constant">enter</span> <span class="constant">a</span> <span class="constant">name:</span> <span class="constant">Paul</span>
<span class="constant function">Please</span> <span class="constant">enter</span> <span class="constant">a</span> <span class="constant">name:</span> <span class="constant">Teg</span>
<span class="constant function">Please</span> <span class="constant">enter</span> <span class="constant">a</span> <span class="constant">name:</span> <span class="constant">Leto</span>
<span class="constant function">Please</span> <span class="constant">enter</span> <span class="constant">a</span> <span class="constant">name:</span>

<span class="constant function">��</span> == <span class="constant">learning.User{</span> <span class="constant">.power</span> <span class="constant">=</span> <span class="constant">1</span> <span class="constant">}</span>

<span class="constant function">���</span> == <span class="constant">learning.User{</span> <span class="constant">.power</span> <span class="constant">=</span> <span class="constant">0</span> <span class="constant">}</span>

<span class="constant function">���</span> == <span class="constant">learning.User{</span> <span class="constant">.power</span> <span class="constant">=</span> <span class="constant">2</span> <span class="constant">}</span>
<span class="constant function">false</span>
</code></pre>
<p>值看起来没问题，但键不一样。如果你不确定发生了什么，那可能是我的错。之前，我故意误导了你的注意力。我说哈希表通常声明周期会比较长，因此需要同等生命周期的值（value）。事实上，哈希表不仅需要长生命周期的值，还需要长生命周期的键（key）！请注意，<code>buf</code> 是在 <code>while</code> 循环中定义的。当我们调用 <code>put</code> 时，我们给了哈希表插入一个键值对，这个键的生命周期比哈希表本身短得多。将 <code>buf</code> 移到 <code>while</code> 循环之外可以解决生命周期问题，但每次迭代都会重复使用缓冲区。由于我们正在更改底层的键数据，因此它仍然无法工作。</p><p>对于上述代码，实际上只有一种解决方案：我们的 <code>lookup</code> 必须拥有键的所有权。我们需要添加一行并修改另一行：</p><pre><code class="zig"><span class="comment_documentation comment spell">// 用这两行替换现有的 lookup.put</span>
<span class="keyword">const</span> <span class="constant variable_builtin type variable">owned_name</span> <span class="operator">=</span> <span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">allocator</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dupe</span><span class="punctuation_bracket">(</span><span class="type_builtin">u8</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">name</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="comment_documentation comment spell">// name -&gt; owned_name</span>
<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">put</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">owned_name</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">power</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">i</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p><code>dupe</code> 是 <code>std.mem.Allocator</code> 中的一个方法，我们以前从未见过。它会分配给定值的副本。代码现在可以工作了，因为我们的键现在在堆上，比 <code>lookup</code>的生命周期更长。事实上，我们在延长这些字符串的生命周期方面做得太好了，以至于引入了内存泄漏。</p><p>你可能以为当我们调用 lookup.deinit 时，键和值就会被释放。但 StringHashMap 并没有放之四海而皆准的解决方案。首先，键可能是字符串文字，无法释放。其次，它们可能是用不同的分配器创建的。最后，虽然更先进，但在某些情况下，键可能不属于哈希表。</p><p>唯一的解决办法就是自己释放键值。在这一点上，创建我们自己的 <code>UserLookup</code> 类型并在 <code>deinit</code> 函数中封装这一清理逻辑可能会比较合理。一种简单的改法：</p><pre><code class="zig"><span class="comment_documentation comment spell">// 用以下的代码替换现有的 defer lookup.deinit();</span>
<span class="constant variable_builtin type variable">defer</span> <span class="punctuation_bracket">{</span>
	<span class="constant variable_builtin type variable">var</span> it <span class="operator">=</span> <span class="constant variable_builtin type variable">lookup</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">keyIterator</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword_repeat">while</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">it</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">next</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket operator">|</span><span class="constant variable_builtin type variable">key</span><span class="punctuation_bracket operator">|</span> <span class="punctuation_bracket">{</span>
		<span class="constant variable_builtin type variable">allocator</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">free</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">key</span><span class="operator">.*</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="punctuation_bracket">}</span>
	lookup<span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">deinit</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>
</code></pre>
<p>这里的 <code>defer</code> 逻辑使用了一个代码快，它释放每个键，最后去释放 <code>lookup</code> 本身。我们使用的 <code>keyIterator</code> 只会遍历键。迭代器的值是指向哈希映射中键的指针，即 <code>*[]const u8</code>。我们希望释放实际的值，因为这是我们通过 <code>dupe</code> 分配的，所以我们使用 <code>key.*</code>.</p><p>我保证，关于悬挂指针和内存管理的讨论已经结束了。我们所讨论的内容可能还不够清晰或过于抽象。当你有更实际的问题需要解决时，再重新讨论这个问题也不迟。不过，如果你打算编写任何稍具规模（non-trivial）的程序，这几乎肯定是你需要掌握的内容。当你觉得可以的时候，我建议你参考上面这个示例，并自己动手实践一下。引入一个 <code>UserLookup</code> 类型来封装我们必须做的所有内存管理。尝试使用 <code>*User</code> 代替 <code>User</code>，在堆上创建用户，然后像处理键那样释放它们。编写覆盖新结构的测试，使用 <code>std.testing.allocator</code> 确保不会泄漏任何内存。</p><h1>ArrayList</h1><p>现在你可以忘掉我们的 <code>IntList</code> 和我们创建的通用替代方案了。Zig 标准库中有一个动态数组实现：<code>std.ArrayList(T)</code>。</p><p>它是相当标准的东西，但由于它如此普遍需要和使用的数据结构，值得看看它的实际应用:</p><pre><code class="zig"><span class="keyword">const</span> <span class="module constant variable_builtin type variable">std</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="keyword">const</span> <span class="constant variable_builtin type variable">Allocator</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">mem</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">Allocator</span><span class="punctuation_delimiter">;</span>
<span class="keyword">const</span> <span class="module constant variable_builtin type variable">builtin</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;builtin&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="keyword_modifier">pub</span> <span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">main</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span> <span class="operator">!</span><span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
	<span class="keyword">var</span> <span class="constant variable_builtin type variable">gpa</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">heap</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">GeneralPurposeAllocator</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">allocator</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">gpa</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">allocator</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">var</span> <span class="constant variable_builtin type variable">arr</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">ArrayList</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">User</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">init</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">allocator</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">defer</span> <span class="punctuation_bracket">{</span>
		<span class="keyword_repeat">for</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">arr</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">items</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket operator">|</span><span class="constant variable_builtin type variable">user</span><span class="punctuation_bracket operator">|</span> <span class="punctuation_bracket">{</span>
			<span class="constant variable_builtin type variable">user</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">deinit</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">allocator</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="punctuation_bracket">}</span>
		<span class="constant variable_builtin type variable">arr</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">deinit</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="punctuation_bracket">}</span>

	<span class="comment_documentation comment spell">// stdin is an std.io.Reader</span>
	<span class="comment_documentation comment spell">// the opposite of an std.io.Writer, which we already saw</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">stdin</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">io</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">getStdIn</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">reader</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="comment_documentation comment spell">// stdout is an std.io.Writer</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">stdout</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">io</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">getStdOut</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">writer</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">var</span> <span class="constant variable_builtin type variable">i</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">i32</span> <span class="operator">=</span> <span class="number">0</span><span class="punctuation_delimiter">;</span>
	<span class="keyword_repeat">while</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">true</span><span class="punctuation_bracket">)</span> <span class="punctuation_delimiter">:</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">i</span> <span class="operator">+=</span> <span class="number">1</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket">{</span>
		<span class="keyword">var</span> <span class="constant variable_builtin type variable">buf</span><span class="punctuation_delimiter">:</span> <span class="punctuation_bracket">[</span><span class="number">30</span><span class="punctuation_bracket">]</span><span class="type_builtin">u8</span> <span class="operator">=</span> <span class="constant_builtin">undefined</span><span class="punctuation_delimiter">;</span>
		<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">stdout</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">print</span><span class="punctuation_bracket">(</span><span class="string">&quot;Please enter a name: &quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">stdin</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">readUntilDelimiterOrEof</span><span class="punctuation_bracket">(</span><span class="operator">&amp;</span><span class="constant variable_builtin type variable">buf</span><span class="punctuation_delimiter">,</span> <span class="character">&apos;</span><span class="character string_escape">\n</span><span class="character">&apos;</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket operator">|</span><span class="constant variable_builtin type variable">line</span><span class="punctuation_bracket operator">|</span> <span class="punctuation_bracket">{</span>
			<span class="keyword">var</span> <span class="constant variable_builtin type variable">name</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">line</span><span class="punctuation_delimiter">;</span>
			<span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">builtin</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">os</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">tag</span> <span class="operator">==</span> <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable">windows</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket">{</span>
				<span class="module constant variable_builtin type variable">name</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@constCast</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">mem</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">trimRight</span><span class="punctuation_bracket">(</span><span class="type_builtin">u8</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">name</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;</span><span class="string string_escape">\r</span><span class="string">&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
			<span class="punctuation_bracket">}</span>

			<span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">name</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">len</span> <span class="operator">==</span> <span class="number">0</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket">{</span>
				<span class="keyword_repeat">break</span><span class="punctuation_delimiter">;</span>
			<span class="punctuation_bracket">}</span>
			<span class="keyword">const</span> <span class="constant variable_builtin type variable">owned_name</span> <span class="operator">=</span> <span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">allocator</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dupe</span><span class="punctuation_bracket">(</span><span class="type_builtin">u8</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">name</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
			<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">arr</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">append</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">name</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">owned_name</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">power</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">i</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="punctuation_bracket">}</span>
	<span class="punctuation_bracket">}</span>

	<span class="keyword">var</span> <span class="constant variable_builtin type variable">has_leto</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">false</span><span class="punctuation_delimiter">;</span>
	<span class="keyword_repeat">for</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">arr</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">items</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket operator">|</span><span class="constant variable_builtin type variable">user</span><span class="punctuation_bracket operator">|</span> <span class="punctuation_bracket">{</span>
		<span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">mem</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">eql</span><span class="punctuation_bracket">(</span><span class="type_builtin">u8</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;Leto&quot;</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">user</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">name</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket">{</span>
			<span class="constant variable_builtin type variable">has_leto</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">true</span><span class="punctuation_delimiter">;</span>
			<span class="keyword_repeat">break</span><span class="punctuation_delimiter">;</span>
		<span class="punctuation_bracket">}</span>
	<span class="punctuation_bracket">}</span>

	<span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">debug</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">print</span><span class="punctuation_bracket">(</span><span class="string">&quot;{any}</span><span class="string string_escape">\n</span><span class="string">&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="constant variable_builtin type variable">has_leto</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>

<span class="keyword">const</span> <span class="constant variable_builtin type variable">User</span> <span class="operator">=</span> <span class="keyword_type">struct</span> <span class="punctuation_bracket">{</span>
	<span class="constant variable_builtin type variable_member variable">name</span><span class="punctuation_delimiter">:</span> <span class="punctuation_bracket">[</span><span class="punctuation_bracket">]</span><span class="keyword">const</span> <span class="type_builtin">u8</span><span class="punctuation_delimiter">,</span>
	<span class="constant variable_builtin type variable_member variable">power</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">i32</span><span class="punctuation_delimiter">,</span>

	<span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">deinit</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin variable_parameter variable type">self</span><span class="punctuation_delimiter">:</span> <span class="constant variable_builtin type variable">User</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin variable_parameter variable type">allocator</span><span class="punctuation_delimiter">:</span> <span class="constant variable_builtin type variable">Allocator</span><span class="punctuation_bracket">)</span> <span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
		<span class="constant variable_builtin type variable">allocator</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">free</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">self</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">name</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="punctuation_bracket">}</span>
<span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>以上是哈希表代码的基于 <code>ArrayList(User)</code> 的另一种实现。所有相同的生命周期和内存管理规则都适用。请注意，我们仍在创建 <code>name</code> 的副本，并且仍在删除 <code>ArrayList</code> 之前释放每个 <code>name</code>。</p><p>现在是指出 Zig 没有属性或私有字段的好时机。当我们访问 <code>arr.items</code> 来遍历值时，就可以看到这一点。没有属性的原因是为了消除阅读 Zig 代码中的歧义。在 Zig 中，如果看起来像字段访问，那就是字段访问。我个人认为，没有私有字段是一个错误，但我们可以解决这个问题。我已经习惯在字段前加上下划线，表示『仅供内部使用』。</p><p>由于字符串的类型是 <code>[]u8</code> 或 <code>[]const u8</code>，因此 <code>ArrayList(u8)</code> 是字符串构造器的合适类型，比如 .NET 的 <code>StringBuilder</code> 或 Go 的 <code>strings.Builder</code>。事实上，当一个函数的参数是 <code>Writer</code> 而你需要一个字符串时，就会用到 <code>ArrayList(u8)</code>。我们之前看过一个使用 <code>std.json.stringify</code> 将 JSON 输出到 <code>stdout</code> 的示例。下面是将 JSON 输出到 <code>ArrayList(u8)</code> 的示例：</p><pre><code class="zig"><span class="keyword">const</span> <span class="module constant variable_builtin type variable">std</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="keyword_modifier">pub</span> <span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">main</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span> <span class="operator">!</span><span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
	<span class="keyword">var</span> <span class="constant variable_builtin type variable">gpa</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">heap</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">GeneralPurposeAllocator</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">allocator</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">gpa</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">allocator</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">var</span> <span class="constant variable_builtin type variable">out</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">ArrayList</span><span class="punctuation_bracket">(</span><span class="type_builtin">u8</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">init</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">allocator</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">defer</span> <span class="constant variable_builtin type variable">out</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">deinit</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">json</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">stringify</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">this_is</span> <span class="operator">=</span> <span class="string">&quot;an anonymous struct&quot;</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">above</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">true</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">last_param</span> <span class="operator">=</span> <span class="string">&quot;are options&quot;</span><span class="punctuation_delimiter">,</span>
	<span class="punctuation_bracket">}</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">whitespace</span> <span class="operator">=</span> <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable">indent_2</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">out</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">writer</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">debug</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">print</span><span class="punctuation_bracket">(</span><span class="string">&quot;{s}</span><span class="string string_escape">\n</span><span class="string">&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="constant variable_builtin type variable">out</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">items</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>
</code></pre>
<h1>Anytype</h1><p>在<a href="/learn/language-overview-part1/">语言概述的第一部分</a>中，我们简要介绍了 <code>anytype</code>。这是一种非常有用的编译时 duck 类型。下面是一个简单的 logger：</p><pre><code class="zig"><span class="keyword_modifier">pub</span> <span class="keyword">const</span> <span class="constant variable_builtin type variable">Logger</span> <span class="operator">=</span> <span class="keyword_type">struct</span> <span class="punctuation_bracket">{</span>
	<span class="constant variable_builtin type variable_member variable">level</span><span class="punctuation_delimiter">:</span> <span class="constant variable_builtin type variable">Level</span><span class="punctuation_delimiter">,</span>

	<span class="comment_documentation comment spell">// &quot;error&quot; is reserved, names inside an @&quot;...&quot; are always</span>
	<span class="comment_documentation comment spell">// treated as identifiers</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">Level</span> <span class="operator">=</span> <span class="keyword_type">enum</span> <span class="punctuation_bracket">{</span>
		<span class="constant variable_builtin type variable">debug</span><span class="punctuation_delimiter">,</span>
		<span class="constant variable_builtin type variable">info</span><span class="punctuation_delimiter">,</span>
		<span class="constant variable_builtin type variable">@</span><span class="string constant variable_builtin type variable">&quot;error&quot;</span><span class="punctuation_delimiter">,</span>
		<span class="constant variable_builtin type variable">fatal</span><span class="punctuation_delimiter">,</span>
	<span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>

	<span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">info</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin variable_parameter variable type">logger</span><span class="punctuation_delimiter">:</span> <span class="constant variable_builtin type variable">Logger</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin variable_parameter variable type">msg</span><span class="punctuation_delimiter">:</span> <span class="punctuation_bracket">[</span><span class="punctuation_bracket">]</span><span class="keyword">const</span> <span class="type_builtin">u8</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin variable_parameter variable type">out</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">anytype</span><span class="punctuation_bracket">)</span> <span class="operator">!</span><span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
		<span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="function_builtin">@intFromEnum</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">logger</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">level</span><span class="punctuation_bracket">)</span> <span class="operator">&lt;=</span> <span class="function_builtin">@intFromEnum</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">Level</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">info</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket">{</span>
			<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">out</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">writeAll</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">msg</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="punctuation_bracket">}</span>
	<span class="punctuation_bracket">}</span>
<span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p><code>info</code> 函数的 <code>out</code> 参数类型为 <code>anytype</code>。这意味着我们的 logger 可以将信息输出到任何具有 writeAll 方法的结构中，该方法接受一个 <code>[]const u8</code> 并返回一个 <code>!void</code>。这不是运行时特性。类型检查在编译时进行，每使用一种类型，就会创建一个类型正确的函数。如果我们试图调用 <code>info</code>，而该类型不具备所有必要的函数（本例中只有 <code>writeAll</code>），我们就会在编译时出错：</p><pre><code class="zig"><span class="keyword">var</span> <span class="constant variable_builtin type variable">l</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">Logger</span><span class="punctuation_bracket">{</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">level</span> <span class="operator">=</span> <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable">info</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">l</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">info</span><span class="punctuation_bracket">(</span><span class="string">&quot;sever started&quot;</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">true</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>会得到如下错误：</p><pre><code class="bash"><span class="constant function">no</span> <span class="constant">field</span> <span class="constant">or</span> <span class="constant">member</span> <span class="constant">function</span> <span class="constant">named</span> <span class="string constant">&apos;writeAll&apos;</span> <span class="constant">in</span> <span class="string constant">&apos;bool&apos;</span>
</code></pre>
<p>使用 <code>ArrayList(u8)</code> 的 <code>writer</code> 就可以运行：</p><pre><code class="zig"><span class="keyword_modifier">pub</span> <span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">main</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span> <span class="operator">!</span><span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
	<span class="keyword">var</span> <span class="constant variable_builtin type variable">gpa</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">heap</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">GeneralPurposeAllocator</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">allocator</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">gpa</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">allocator</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">var</span> <span class="constant variable_builtin type variable">l</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">Logger</span><span class="punctuation_bracket">{</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">level</span> <span class="operator">=</span> <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable">info</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">var</span> <span class="constant variable_builtin type variable">arr</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">ArrayList</span><span class="punctuation_bracket">(</span><span class="type_builtin">u8</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">init</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">allocator</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">defer</span> <span class="constant variable_builtin type variable">arr</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">deinit</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">l</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">info</span><span class="punctuation_bracket">(</span><span class="string">&quot;sever started&quot;</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">arr</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">writer</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">debug</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">print</span><span class="punctuation_bracket">(</span><span class="string">&quot;{s}</span><span class="string string_escape">\n</span><span class="string">&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="constant variable_builtin type variable">arr</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">items</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>
</code></pre>
<p><code>anytype</code> 的一个最大缺点就是文档。下面是我们用过几次的 <code>std.json.stringify</code> 函数的签名：</p><pre><code class="zig"><span class="comment_documentation comment spell">// 我**讨厌**多行函数定义</span>
<span class="comment_documentation comment spell">// 不过，鉴于你可能在小屏幕上阅读这个指南，因此这里破一次例。</span>

<span class="keyword_function">fn</span> <span class="constant variable_builtin type variable">stringify</span><span class="punctuation_bracket">(</span>
	<span class="constant variable_builtin variable_parameter variable type">value</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">anytype</span><span class="punctuation_delimiter">,</span>
	<span class="constant variable_builtin variable_parameter variable type">options</span><span class="punctuation_delimiter">:</span> <span class="constant variable_builtin type variable">StringifyOptions</span><span class="punctuation_delimiter">,</span>
	<span class="constant variable_builtin variable_parameter variable type">out_stream</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">anytype</span>
<span class="punctuation_bracket">)</span> <span class="function_builtin">@TypeOf</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">out_stream</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">Error</span><span class="operator">!</span><span class="type_builtin">void</span>
</code></pre>
<p>第一个参数 <code>value: anytype</code> 是显而易见的，它是要序列化的值，可以是任何类型（实际上，Zig 的 JSON 序列化器不能序列化某些类型，比如 HashMap）。我们可以猜测，<code>out_stream</code> 是写入 JSON 的地方，但至于它需要实现什么方法，你和我一样猜得到。唯一的办法就是阅读源代码，或者传递一个假值，然后使用编译器错误作为我们的文档。如果有更好的自动文档生成器，这一点可能会得到改善。不过，我希望 Zig 能提供接口，这已经不是第一次了。</p><h1>@TypeOf</h1><p>在前面的部分中，我们使用 <code>@TypeOf</code> 来帮助我们检查各种变量的类型。从我们的用法来看，你可能会认为它返回的是字符串类型的名称。然而，鉴于它是一个 PascalCase 风格函数，你应该更清楚：它返回的是一个 <code>type</code>。</p><p>我最喜欢用 <code>anytype</code> 与 <code>@TypeOf</code> 和 <code>@hasField</code> 内置函数搭配使用，以编写测试帮助程序。虽然我们看到的每个 <code>User</code> 类型都非常简单，但我还是要请大家想象一下一个有很多字段的更复杂的结构。在许多测试中，我们需要一个 <code>User</code>，但我们只想指定与测试相关的字段。让我们创建一个 <code>userFactory</code>：</p><pre><code class="zig"><span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">userFactory</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin variable_parameter variable type">data</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">anytype</span><span class="punctuation_bracket">)</span> <span class="constant variable_builtin type variable">User</span> <span class="punctuation_bracket">{</span>
	<span class="keyword">const</span> <span class="module constant variable_builtin type variable">T</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@TypeOf</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">data</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword_return">return</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">id</span> <span class="operator">=</span> <span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="function_builtin">@hasField</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">T</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;id&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span> <span class="constant variable_builtin type variable">data</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">id</span> <span class="keyword_conditional">else</span> <span class="number">0</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">power</span> <span class="operator">=</span> <span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="function_builtin">@hasField</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">T</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;power&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span> <span class="constant variable_builtin type variable">data</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">power</span> <span class="keyword_conditional">else</span> <span class="number">0</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">active</span>  <span class="operator">=</span> <span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="function_builtin">@hasField</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">T</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;active&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span> <span class="constant variable_builtin type variable">data</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">active</span> <span class="keyword_conditional">else</span> <span class="constant variable_builtin type variable">true</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">name</span>  <span class="operator">=</span> <span class="keyword_conditional">if</span> <span class="punctuation_bracket">(</span><span class="function_builtin">@hasField</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">T</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;name&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span> <span class="constant variable_builtin type variable">data</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">name</span> <span class="keyword_conditional">else</span> <span class="string">&quot;&quot;</span><span class="punctuation_delimiter">,</span>
	<span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>

<span class="keyword_modifier">pub</span> <span class="keyword">const</span> <span class="constant variable_builtin type variable">User</span> <span class="operator">=</span> <span class="keyword_type">struct</span> <span class="punctuation_bracket">{</span>
	<span class="constant variable_builtin type variable_member variable">id</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">u64</span><span class="punctuation_delimiter">,</span>
	<span class="constant variable_builtin type variable_member variable">power</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">u64</span><span class="punctuation_delimiter">,</span>
	<span class="constant variable_builtin type variable_member variable">active</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">bool</span><span class="punctuation_delimiter">,</span>
	<span class="constant variable_builtin type variable_member variable">name</span><span class="punctuation_delimiter">:</span> <span class="punctuation_bracket">[</span><span class="punctuation_bracket">]</span> <span class="keyword">const</span> <span class="type_builtin">u8</span><span class="punctuation_delimiter">,</span>
<span class="punctuation_bracket">}</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>我们可以通过调用 <code>userFactory(.{})</code> 创建默认用户，也可以通过 <code>userFactory(.{.id = 100, .active = false})</code> 来覆盖特定字段。这只是一个很小的模式，但我非常喜欢。这也是迈向元编程世界的第一步。</p><p>更常见的是 <code>@TypeOf</code> 与 <code>@typeInfo</code> 配对，后者返回一个 <code>std.builtin.Type</code>。这是一个功能强大的带标签的联合（tagged union），可以完整描述一个类型。<code>std.json.stringify</code> 函数会递归地调用它，以确定如何将提供的 <code>value</code> 序列化。</p><h1>构建系统</h1><p>如果你通读了整本指南，等待着深入了解如何建立更复杂的项目，包括多个依赖关系和各种目标，那你就要失望了。Zig 拥有强大的构建系统，以至于越来越多的非 Zig 项目都在使用它，比如 libsodium。不幸的是，所有这些强大的功能都意味着，对于简单的需求来说，它并不是最容易使用或理解的。</p><blockquote><p>事实上，是我不太了解 Zig 的构建系统，所以无法解释清楚。</p></blockquote><p>不过，我们至少可以获得一个简要的概述。为了运行 Zig 代码，我们使用了 <code>zig run learning.zig</code>。有一次，我们还用 <code>zig test learning.zig</code> 进行了一次测试。运行和测试命令用来玩玩还行，但如果要做更复杂的事情，就需要使用构建命令了。编译命令依赖于带有特殊编译入口的 <code>build.zig</code> 文件。下面是一个示例：</p><pre><code class="zig"><span class="comment_documentation comment spell">// build.zig</span>

<span class="keyword">const</span> <span class="module constant variable_builtin type variable">std</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="keyword_modifier">pub</span> <span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">build</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin variable_parameter variable type">b</span><span class="punctuation_delimiter">:</span> <span class="operator">*</span><span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">Build</span><span class="punctuation_bracket">)</span> <span class="operator">!</span><span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
	<span class="constant variable_builtin type variable">_</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>
</code></pre>
<p>每个构建程序都有一个默认的『安装』步骤，可以使用 <code>zig build install</code> 运行它，但由于我们的文件大部分是空的，你不会得到任何有意义的工件。我们需要告诉构建程序我们程序的入口是 <code>learning.zig</code>：</p><pre><code class="zig"><span class="keyword">const</span> <span class="module constant variable_builtin type variable">std</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="keyword_modifier">pub</span> <span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">build</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin variable_parameter variable type">b</span><span class="punctuation_delimiter">:</span> <span class="operator">*</span><span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">Build</span><span class="punctuation_bracket">)</span> <span class="operator">!</span><span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">target</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">standardTargetOptions</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">optimize</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">standardOptimizeOption</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="comment_documentation comment spell">// setup executable</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">exe</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addExecutable</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">name</span> <span class="operator">=</span> <span class="string">&quot;learning&quot;</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">target</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">target</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">optimize</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">optimize</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">root_source_file</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">path</span><span class="punctuation_bracket">(</span><span class="string">&quot;learning.zig&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">,</span>
	<span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">installArtifact</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">exe</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>
</code></pre>
<p>现在，如果运行 <code>zig build install</code>，就会在 <code>./zig-out/bin/learning</code> 中得到一个二进制文件。通过使用 <code>standardTargetOptions</code> 和 <code>standardOptimizeOption</code>，我们就能以命令行参数的形式覆盖默认值。例如，要为 <code>Windows</code> 构建一个大小优化的程序版本，我们可以这样做：</p><pre><code class="bash"><span class="constant function">zig</span> <span class="constant">build</span> <span class="constant">install</span> <span class="constant">-Doptimize=ReleaseSmall</span> <span class="constant">-Dtarget=x86_64-windows-gnu</span>
</code></pre>
<p>除了默认的『安装』步骤外，可执行文件通常还会增加两个步骤：『运行』和『测试』。一个库可能只有一个『测试』步骤。对于基本的无参数即可运行的程序来说，只需要在构建文件的最后添加四行：</p><pre><code class="zig"><span class="comment_documentation comment spell">// 在这行代码后添加下面的代码: b.installArtifact(exe);</span>

<span class="keyword">const</span> <span class="constant variable_builtin type variable">run_cmd</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addRunArtifact</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">exe</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="constant variable_builtin type variable">run_cmd</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">step</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dependOn</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">getInstallStep</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="keyword">const</span> <span class="constant variable_builtin type variable">run_step</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">step</span><span class="punctuation_bracket">(</span><span class="string">&quot;run&quot;</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;Start learning!&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="constant variable_builtin type variable">run_step</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dependOn</span><span class="punctuation_bracket">(</span><span class="operator">&amp;</span><span class="constant variable_builtin type variable">run_cmd</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">step</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>这里通过 <code>dependOn</code> 的两次调用创建两个依赖关系。第一个依赖关系将我们的 <code>run_cmd</code> 与内置的安装步骤联系起来。第二个是将 <code>run_step</code> 与我们新创建的 <code>run_cmd</code> 绑定。你可能想知道为什么需要 <code>run_cmd</code> 和 <code>run_step</code>。我认为这种分离是为了支持更复杂的设置：依赖于多个命令的步骤，或者在多个步骤中使用的命令。如果运行 <code>zig build --help</code> 并滚动到顶部，你会看到新增的 <code>run</code> 步骤。现在你可以执行 <code>zig build run</code> 来运行程序了。</p><p>要添加『测试』步骤，你需要重复刚才添加的大部分运行代码，只是不再使用 <code>b.addExecutable</code>，而是使用 <code>b.addTest</code>：</p><pre><code class="zig"><span class="keyword">const</span> <span class="constant variable_builtin type variable">tests</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addTest</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
	<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">target</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">target</span><span class="punctuation_delimiter">,</span>
	<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">optimize</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">optimize</span><span class="punctuation_delimiter">,</span>
	<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">root_source_file</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">path</span><span class="punctuation_bracket">(</span><span class="string">&quot;learning.zig&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">,</span>
<span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="keyword">const</span> <span class="constant variable_builtin type variable">test_cmd</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addRunArtifact</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">tests</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="constant variable_builtin type variable">test_cmd</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">step</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dependOn</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">getInstallStep</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="keyword">const</span> <span class="constant variable_builtin type variable">test_step</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">step</span><span class="punctuation_bracket">(</span><span class="string">&quot;test&quot;</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;Run the tests&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="constant variable_builtin type variable">test_step</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dependOn</span><span class="punctuation_bracket">(</span><span class="operator">&amp;</span><span class="constant variable_builtin type variable">test_cmd</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">step</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>我们将该步骤命名为 <code>test</code>。运行 <code>zig build --help</code> 会显示另一个可用步骤 <code>test</code>。由于我们没有进行任何测试，因此很难判断这一步是否有效。在 <code>learning.zig</code> 中，添加</p><pre><code class="zig"><span class="keyword">test</span> <span class="string">&quot;dummy build test&quot;</span> <span class="punctuation_bracket">{</span>
	<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">testing</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">expectEqual</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">false</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">true</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>
</code></pre>
<p>现在运行 <code>zig build test</code>时，应该会出现测试失败。如果你修复了测试，并再次运行 <code>zig build test</code>，你将不会得到任何输出。默认情况下，Zig 的测试运行程序只在失败时输出结果。如果你像我一样，无论成功还是失败，都想要一份总结，那就使用 <code>zig build test --summary all</code>。</p><p>这是启动和运行构建系统所需的最低配置。但是请放心,如果你需要构建你的程序，Zig 内置的功能大概率能覆盖你的需求。最后，你可以（也应该）在你的项目根目录下使用 <code>zig init</code>，让 Zig 为你创建一个文档齐全的 <code>build.zig</code> 文件。</p><h1>第三方依赖</h1><p>Zig 的内置软件包管理器相对较新，因此存在一些缺陷。虽然还有改进的余地，但它目前还是可用的。我们需要了解两个部分：创建软件包和使用软件包。我们将对其进行全面介绍。</p><p>首先，新建一个名为 <code>calc</code> 的文件夹并创建三个文件。第一个是 <code>add.zig</code>，内容如下：</p><pre><code class="zig"><span class="comment_documentation comment spell">// 哦，下面的函数定义中有语法之前没讲过，看看 b 的类型和返回类型！！</span>

<span class="keyword_modifier">pub</span> <span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">add</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin variable_parameter variable type">a</span><span class="punctuation_delimiter">:</span> <span class="type_builtin">anytype</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin variable_parameter variable type">b</span><span class="punctuation_delimiter">:</span> <span class="function_builtin">@TypeOf</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">a</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span> <span class="function_builtin">@TypeOf</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">a</span><span class="punctuation_bracket">)</span> <span class="punctuation_bracket">{</span>
	<span class="keyword_return">return</span> <span class="constant variable_builtin type variable">a</span> <span class="operator">+</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>

<span class="keyword">const</span> <span class="constant variable_builtin type variable">testing</span> <span class="operator">=</span> <span class="function_builtin">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">testing</span><span class="punctuation_delimiter">;</span>
<span class="keyword">test</span> <span class="string">&quot;add&quot;</span> <span class="punctuation_bracket">{</span>
	<span class="keyword_exception">try</span> <span class="constant variable_builtin type variable">testing</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">expectEqual</span><span class="punctuation_bracket">(</span><span class="function_builtin">@as</span><span class="punctuation_bracket">(</span><span class="type_builtin">i32</span><span class="punctuation_delimiter">,</span> <span class="number">32</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin function_call variable type">add</span><span class="punctuation_bracket">(</span><span class="number">30</span><span class="punctuation_delimiter">,</span> <span class="number">2</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>
</code></pre>
<p>这个例子可能看起来有点傻，一整个软件包只是为了加两个数值，但它能让我们专注于打包方面。接下来，我们将添加一个同样愚蠢的：<code>calc.zig</code>：</p><pre><code class="zig"><span class="keyword_modifier">pub</span> <span class="keyword">const</span> <span class="constant variable_builtin type variable">add</span> <span class="operator">=</span> <span class="function_builtin">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;add.zig&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">add</span><span class="punctuation_delimiter">;</span>

<span class="keyword">test</span> <span class="punctuation_bracket">{</span>
	<span class="comment_documentation comment spell">// By default, only tests in the specified file</span>
	<span class="comment_documentation comment spell">// are included. This magic line of code will</span>
	<span class="comment_documentation comment spell">// cause a reference to all nested containers</span>
	<span class="comment_documentation comment spell">// to be tested.</span>
	<span class="function_builtin">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">testing</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">refAllDecls</span><span class="punctuation_bracket">(</span><span class="function_builtin">@This</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>
</code></pre>
<p>我们将其分割为 <code>calc.zig</code> 和 <code>add.zig</code>，以证明 <code>zig build</code> 可以自动构建和打包所有项目文件。最后，我们可以添加 build.zig：</p><pre><code class="zig"><span class="keyword">const</span> <span class="module constant variable_builtin type variable">std</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="keyword_modifier">pub</span> <span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">build</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin variable_parameter variable type">b</span><span class="punctuation_delimiter">:</span> <span class="operator">*</span><span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">Build</span><span class="punctuation_bracket">)</span> <span class="operator">!</span><span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">target</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">standardTargetOptions</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">optimize</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">standardOptimizeOption</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">const</span> <span class="constant variable_builtin type variable">tests</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addTest</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">target</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">target</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">optimize</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">optimize</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">root_source_file</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">path</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc.zig&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">,</span>
	<span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">const</span> <span class="constant variable_builtin type variable">test_cmd</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addRunArtifact</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">tests</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="constant variable_builtin type variable">test_cmd</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">step</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dependOn</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">getInstallStep</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">test_step</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">step</span><span class="punctuation_bracket">(</span><span class="string">&quot;test&quot;</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;Run the tests&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="constant variable_builtin type variable">test_step</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dependOn</span><span class="punctuation_bracket">(</span><span class="operator">&amp;</span><span class="constant variable_builtin type variable">test_cmd</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">step</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="punctuation_bracket">}</span>
</code></pre>
<p>这些都是我们在上一节中看到的内容的重复。有了这些，你就可以运行 <code>zig build test --summary all</code>。</p><p>回到我们的 <code>learning</code>项目和之前创建的 <code>build.zig</code>。首先，我们将添加本地 <code>calc</code> 作为依赖项。我们需要添加三项内容。首先，我们将创建一个指向 <code>calc.zig</code>的模块：</p><pre><code class="zig"><span class="comment_documentation comment spell">// 你可以把这些代码放在构建函数的顶部，</span>
<span class="comment_documentation comment spell">// 即调用 addExecutable 之前。</span>

<span class="keyword">const</span> <span class="constant variable_builtin type variable">calc_module</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addModule</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
	<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">root_source_file</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">path</span><span class="punctuation_bracket">(</span><span class="string">&quot;PATH_TO_CALC_PROJECT/calc.zig&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">,</span>
<span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>你需要调整 <code>calc.zig</code> 的路径。现在，我们需要将这个模块添加到现有的 <code>exe</code> 和 <code>tests</code> 变量中。由于我们的 build.zig 变得越来越复杂，我们将尝试稍微组织一下：</p><pre><code class="zig"><span class="keyword">const</span> <span class="module constant variable_builtin type variable">std</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="keyword_modifier">pub</span> <span class="keyword_function">fn</span> <span class="constant variable_builtin type variable function">build</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin variable_parameter variable type">b</span><span class="punctuation_delimiter">:</span> <span class="operator">*</span><span class="constant variable_builtin type variable">std</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">Build</span><span class="punctuation_bracket">)</span> <span class="operator">!</span><span class="type_builtin">void</span> <span class="punctuation_bracket">{</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">target</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">standardTargetOptions</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="keyword">const</span> <span class="constant variable_builtin type variable">optimize</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">standardOptimizeOption</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="keyword">const</span> <span class="constant variable_builtin type variable">calc_module</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addModule</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
		<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">root_source_file</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">path</span><span class="punctuation_bracket">(</span><span class="string">&quot;PATH_TO_CALC_PROJECT/calc.zig&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">,</span>
	<span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

	<span class="punctuation_bracket">{</span>
		<span class="comment_documentation comment spell">// 设置我们的 &quot;run&quot; 命令。</span>

		<span class="keyword">const</span> <span class="constant variable_builtin type variable">exe</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addExecutable</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
			<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">name</span> <span class="operator">=</span> <span class="string">&quot;learning&quot;</span><span class="punctuation_delimiter">,</span>
			<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">target</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">target</span><span class="punctuation_delimiter">,</span>
			<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">optimize</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">optimize</span><span class="punctuation_delimiter">,</span>
			<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">root_source_file</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">path</span><span class="punctuation_bracket">(</span><span class="string">&quot;learning.zig&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="comment_documentation comment spell">// 添加这些代码</span>
		<span class="constant variable_builtin type variable">exe</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">root_module</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addImport</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc&quot;</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">calc_module</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">installArtifact</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">exe</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

		<span class="keyword">const</span> <span class="constant variable_builtin type variable">run_cmd</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addRunArtifact</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">exe</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="constant variable_builtin type variable">run_cmd</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">step</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dependOn</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">getInstallStep</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

		<span class="keyword">const</span> <span class="constant variable_builtin type variable">run_step</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">step</span><span class="punctuation_bracket">(</span><span class="string">&quot;run&quot;</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;Start learning!&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="constant variable_builtin type variable">run_step</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dependOn</span><span class="punctuation_bracket">(</span><span class="operator">&amp;</span><span class="constant variable_builtin type variable">run_cmd</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">step</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="punctuation_bracket">}</span>

	<span class="punctuation_bracket">{</span>
		<span class="comment_documentation comment spell">// 设置我们的 &quot;test&quot; 命令。</span>
		<span class="keyword">const</span> <span class="constant variable_builtin type variable">tests</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addTest</span><span class="punctuation_bracket">(</span><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
			<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">target</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">target</span><span class="punctuation_delimiter">,</span>
			<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">optimize</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">optimize</span><span class="punctuation_delimiter">,</span>
			<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">root_source_file</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">path</span><span class="punctuation_bracket">(</span><span class="string">&quot;learning.zig&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">,</span>
		<span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="comment_documentation comment spell">// 添加这行代码</span>
		<span class="constant variable_builtin type variable">tests</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">root_module</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addImport</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc&quot;</span><span class="punctuation_delimiter">,</span> <span class="constant variable_builtin type variable">calc_module</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

		<span class="keyword">const</span> <span class="constant variable_builtin type variable">test_cmd</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addRunArtifact</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">tests</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="constant variable_builtin type variable">test_cmd</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">step</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dependOn</span><span class="punctuation_bracket">(</span><span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">getInstallStep</span><span class="punctuation_bracket">(</span><span class="punctuation_bracket">)</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="keyword">const</span> <span class="constant variable_builtin type variable">test_step</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">step</span><span class="punctuation_bracket">(</span><span class="string">&quot;test&quot;</span><span class="punctuation_delimiter">,</span> <span class="string">&quot;Run the tests&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
		<span class="constant variable_builtin type variable">test_step</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dependOn</span><span class="punctuation_bracket">(</span><span class="operator">&amp;</span><span class="constant variable_builtin type variable">test_cmd</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">step</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
	<span class="punctuation_bracket">}</span>
<span class="punctuation_bracket">}</span>
</code></pre>
<p>现在，可以在项目中 <code>@import(&quot;calc&quot;)</code>：</p><pre><code class="zig"><span class="keyword">const</span> <span class="module constant variable_builtin type variable">calc</span> <span class="operator">=</span> <span class="function_builtin keyword_import">@import</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="variable_builtin">...</span>
<span class="constant variable_builtin type variable">calc</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">add</span><span class="punctuation_bracket">(</span><span class="number">1</span><span class="punctuation_delimiter">,</span> <span class="number">2</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>添加远程依赖关系需要花费更多精力。首先，我们需要回到 <code>calc</code> 项目并定义一个模块。你可能认为项目本身就是一个模块，但一个项目（project）可以暴露多个模块（module），所以我们需要明确地创建它。我们使用相同的 <code>addModule</code>，但舍弃了返回值。只需调用 <code>addModule</code> 就足以定义模块，然后其他项目就可以导入该模块。</p><pre><code class="zig"><span class="constant variable_builtin type variable">_</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addModule</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
	<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">root_source_file</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">path</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc.zig&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">,</span>
<span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>这是我们需要对库进行的唯一改动。因为这是一个远程依赖的练习，所以我把这个 <code>calc</code> 项目推送到了 GitHub，这样我们就可以把它导入到我们的 <code>learning</code> 项目中。它可以在 <a href="https://github.com/karlseguin/calc.zig" target="_blank">https://github.com/karlseguin/calc.zig</a> 上找到。</p><p>回到我们的 <code>learning</code>项目，我们需要一个新文件 <code>build.zig.zon</code>。ZON 是 Zig Object Notation 的缩写，它允许以人类可读格式表达 Zig 数据，并将人类可读格式转化为 Zig 代码。<code>build.zig.zon</code> 的内容包括：</p><pre><code class="zig"><span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
  <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">name</span> <span class="operator">=</span> <span class="string">&quot;learning&quot;</span><span class="punctuation_delimiter">,</span>
  <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">paths</span> <span class="operator">=</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="string">&quot;&quot;</span><span class="punctuation_bracket">}</span><span class="punctuation_delimiter">,</span>
  <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">version</span> <span class="operator">=</span> <span class="string">&quot;0.0.0&quot;</span><span class="punctuation_delimiter">,</span>
  <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">dependencies</span> <span class="operator">=</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
    <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">calc</span> <span class="operator">=</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
      <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">url</span> <span class="operator">=</span> <span class="string">&quot;https://github.com/karlseguin/calc.zig/archive/d1881b689817264a5644b4d6928c73df8cf2b193.tar.gz&quot;</span><span class="punctuation_delimiter">,</span>
      <span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">hash</span> <span class="operator">=</span> <span class="string">&quot;12ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff&quot;</span>
    <span class="punctuation_bracket">}</span><span class="punctuation_delimiter">,</span>
  <span class="punctuation_bracket">}</span><span class="punctuation_delimiter">,</span>
<span class="punctuation_bracket">}</span>
</code></pre>
<p>该文件中有两个可疑值，第一个是 url 中的 d1881b689817264a5644b4d6928c73df8cf2b193<。这只是 git 提交的哈希值。第二个是哈希值。据我所知，目前还没有很好的方法来告诉我们这个值应该是多少，所以我们暂时使用一个假值。</p><p>要使用这一依赖关系，我们需要对 <code>build.zig</code> 进行一处修改：</p><pre><code class="zig"><span class="comment_documentation comment spell">// 将这些代码:</span>
<span class="keyword">const</span> <span class="constant variable_builtin type variable">calc_module</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">addModule</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span>
	<span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">root_source_file</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">path</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc/calc.zig&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">,</span>
<span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>

<span class="comment_documentation comment spell">// 替换成:</span>
<span class="keyword">const</span> <span class="constant variable_builtin type variable">calc_dep</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">b</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">dependency</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc&quot;</span><span class="punctuation_delimiter">,</span> <span class="punctuation_delimiter">.</span><span class="punctuation_bracket">{</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">target</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">target</span><span class="punctuation_delimiter">,</span><span class="punctuation_delimiter">.</span><span class="constant variable_builtin type variable_member variable">optimize</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">optimize</span><span class="punctuation_bracket">}</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
<span class="keyword">const</span> <span class="constant variable_builtin type variable">calc_module</span> <span class="operator">=</span> <span class="constant variable_builtin type variable">calc_dep</span><span class="punctuation_delimiter">.</span><span class="type constant variable_builtin function_call variable_member variable">module</span><span class="punctuation_bracket">(</span><span class="string">&quot;calc&quot;</span><span class="punctuation_bracket">)</span><span class="punctuation_delimiter">;</span>
</code></pre>
<p>在 <code>build.zig.zon</code> 中，我们将依赖关系命名为 <code>calc</code>，这就是我们要加载的依赖关系。在这个依赖关系中，我们将使用其中的 <code>calc</code> 模块，也就是我们在 <code>calc</code> 的 <code>build.zig.zon</code> 中命名的模块。</p><p>如果你尝试运行 <code>zig build test</code>，应该会看到一个错误：</p><pre><code class="bash"><span class="constant function">hash</span> <span class="constant">mismatch:</span> <span class="constant">manifest</span> <span class="constant">declares</span>
<span class="constant function">122053da05e0c9348d91218ef015c8307749ef39f8e90c208a186e5f444e818672da</span>

<span class="constant function">but</span> <span class="constant">the</span> <span class="constant">fetched</span> <span class="constant">package</span> <span class="constant">has</span>
<span class="constant function">122036b1948caa15c2c9054286b3057877f7b152a5102c9262511bf89554dc836ee5</span>
</code></pre>
<p>将正确的哈希值复制并粘贴回 <code>build.zig.zon</code>，然后再次尝试运行 <code>zig build test</code>，现在一切应该都正常了。</p><p>听起来很多，我希望能精简一些。但这主要是你可以从其他项目中复制和粘贴的东西，一旦设置完成，你就可以继续了。</p><p>需要提醒的是，我发现 Zig 对依赖项的缓存偏激。如果你试图更新依赖项，但 Zig 似乎检测不到变化。这时，我会删除项目的 <code>zig-cache</code> 文件夹以及 <code>~/.cache/zig</code>。</p><hr><p>我们已经涉猎了很多领域，探索了一些核心数据结构，并将之前的大块内容整合到了一起。我们的代码变得复杂了一些，不再那么注重特定的语法，看起来更像真正的代码。让我感到兴奋的是，尽管如此复杂，但代码大部分都是有意义的。如果暂时没有看懂，也不要放弃。选取一个示例并将其分解，添加打印语句，为其编写一些测试。亲自动手编写自己的代码，然后再回来阅读那些没有看懂的部分。</p></div>

    <footer>
      <div>
        <div>
          <p>&copy; 2022–2025 |
            <a href="https://github.com/zigcc/zigcc.github.io">Source Code</a>
            |
            <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">BY-NC-ND 4.0</a>
            |
            <!--TODO <a href="/index.xml">RSS</a> --></p>
        </div>
        <div>
          <a href="https://github.com/orgs/zigcc/discussions">
            <i class="fab fa-github"></i>
          </a>
          <a href="https://discord.gg/UraRxD6WXD">
            <i class="fab fa-discord"></i>
          </a>
          <a href="https://t.me/ZigChinese">
            <i class="fab fa-telegram"></i>
          </a>
          <a href="mailto:hello@ziglang.cc">
            <i class="fa fa-envelope"></i>
          </a>
        </div>
      </div>
    </footer>
  </body>
</html>